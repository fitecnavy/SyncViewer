var e=Object.defineProperty,t=(t,r,n)=>((t,r,n)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n)(t,"symbol"!=typeof r?r+"":r,n);import{r,a as n,R as o}from"./react-vendor-BXk_ma1u.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var i={exports:{}},s={},a=r,l=Symbol.for("react.element"),c=Symbol.for("react.fragment"),d=Object.prototype.hasOwnProperty,p=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,h={key:!0,ref:!0,__self:!0,__source:!0};function g(e,t,r){var n,o={},i=null,s=null;for(n in void 0!==r&&(i=""+r),void 0!==t.key&&(i=""+t.key),void 0!==t.ref&&(s=t.ref),t)d.call(t,n)&&!h.hasOwnProperty(n)&&(o[n]=t[n]);if(e&&e.defaultProps)for(n in t=e.defaultProps)void 0===o[n]&&(o[n]=t[n]);return{$$typeof:l,type:e,key:i,ref:s,props:o,_owner:p.current}}s.Fragment=c,s.jsx=g,s.jsxs=g,i.exports=s;var u=i.exports,f={},y=n;f.createRoot=y.createRoot,f.hydrateRoot=y.hydrateRoot;const x={apiKey:"AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",clientId:"771509966039-u1t1h5ed2f2r0f3ur3jmcouhfbu3igmn.apps.googleusercontent.com",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:"https://www.googleapis.com/auth/drive.file"},w=({onAuthChange:e})=>{const[t,n]=r.useState(!1),[o,i]=r.useState(!1),[s,a]=r.useState(null);r.useEffect(()=>{l()},[]);const l=()=>{if("undefined"==typeof gapi)return console.error("gapi is undefined"),void a("Google API 스크립트가 로드되지 않았습니다.");const e=[];if(e.length>0)return console.error("Configuration errors:",e),void a(`설정 오류: ${e.join(", ")}`);console.log("Initializing Google Auth with:",{apiKey:x.apiKey.substring(0,10)+"...",clientId:x.clientId.substring(0,20)+"...",hasEnvVars:{apiKey:!0,clientId:!0}}),gapi.load("client:auth2",async()=>{var e;try{console.log("gapi.load callback executed"),await gapi.client.init({apiKey:x.apiKey,clientId:x.clientId,discoveryDocs:x.discoveryDocs,scope:x.scope}),console.log("gapi.client.init completed");const e=gapi.auth2.getAuthInstance();console.log("authInstance:",e),e.isSignedIn.listen(e=>{c(e)}),c(e.isSignedIn.get()),n(!0),console.log("Google Auth initialized successfully")}catch(t){console.error("Error initializing Google Auth (full error):",t),console.error("Error details:",{message:null==t?void 0:t.message,details:null==t?void 0:t.details,error:null==t?void 0:t.error,result:null==t?void 0:t.result});let r="알 수 없는 오류";(null==t?void 0:t.details)?r=t.details:(null==t?void 0:t.error)?r=`${t.error}: ${t.error_description||""}`:(null==(e=null==t?void 0:t.result)?void 0:e.error)?r=`${t.result.error.message} (${t.result.error.code})`:(null==t?void 0:t.message)&&(r=t.message),a(`Google 인증 초기화 실패: ${r}`)}})},c=t=>{if(i(t),t){const t=gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile(),r={id:t.getId(),email:t.getEmail(),name:t.getName(),picture:t.getImageUrl()};e(!0,r)}else e(!1,null)},d=()=>{gapi.auth2.getAuthInstance().signIn()};return s?u.jsx("div",{style:m.errorContainer,children:u.jsxs("div",{style:m.errorCard,children:[u.jsx("h2",{style:m.errorTitle,children:"인증 오류"}),u.jsx("p",{style:m.error,children:s}),u.jsx("button",{onClick:()=>window.location.reload(),style:m.retryButton,children:"새로고침"}),u.jsxs("div",{style:m.helpText,children:[u.jsx("p",{children:"문제가 계속되면 다음을 확인하세요:"}),u.jsxs("ul",{style:m.helpList,children:[u.jsx("li",{children:"Google Cloud Console에서 OAuth 클라이언트 ID가 설정되었는지 확인"}),u.jsx("li",{children:"승인된 JavaScript 원본에 현재 도메인이 추가되었는지 확인"}),u.jsx("li",{children:"브라우저 콘솔(F12)에서 자세한 오류 메시지 확인"})]})]})]})}):t?o?u.jsx("div",{style:m.signedInContainer,children:u.jsx("button",{onClick:()=>{gapi.auth2.getAuthInstance().signOut()},style:m.signOutButton,children:"로그아웃"})}):u.jsx("div",{style:m.signInContainer,children:u.jsxs("div",{style:m.signInCard,children:[u.jsx("h1",{style:m.title,children:"SyncViewer"}),u.jsx("p",{style:m.subtitle,children:"PC와 모바일 간 동기화되는 텍스트 뷰어"}),u.jsx("button",{onClick:d,style:m.signInButton,children:"Google 계정으로 로그인"})]})}):u.jsx("div",{style:m.loadingContainer,children:u.jsx("p",{children:"Google 인증을 초기화하는 중..."})})},m={signInContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},signInCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",textAlign:"center",maxWidth:"400px"},title:{fontSize:"32px",fontWeight:"bold",marginBottom:"16px",color:"#333"},subtitle:{fontSize:"16px",color:"#666",marginBottom:"32px"},signInButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},signedInContainer:{position:"absolute",top:"16px",right:"16px"},signOutButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},errorContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},errorCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",maxWidth:"600px"},errorTitle:{fontSize:"24px",fontWeight:"bold",marginBottom:"16px",color:"#333"},error:{color:"#f44336",fontSize:"16px",marginBottom:"24px",padding:"12px",backgroundColor:"#ffebee",borderRadius:"4px",border:"1px solid #ffcdd2"},retryButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500",marginBottom:"24px"},helpText:{fontSize:"14px",color:"#666",textAlign:"left"},helpList:{marginTop:"8px",paddingLeft:"20px"}},b=class e{constructor(){t(this,"isInitialized",!1),t(this,"LIBRARY_FOLDER_NAME","SyncViewer_Library"),t(this,"PROGRESS_FOLDER_NAME","SyncViewer_Progress"),t(this,"libraryFolderId",null),t(this,"progressFolderId",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(){this.isInitialized||(await new Promise(e=>{gapi.load("client",async()=>{await gapi.client.init({apiKey:"AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),this.isInitialized=!0,e()})}),await this.ensureFoldersExist())}async ensureFoldersExist(){this.libraryFolderId=await this.findOrCreateFolder(this.LIBRARY_FOLDER_NAME),this.progressFolderId=await this.findOrCreateFolder(this.PROGRESS_FOLDER_NAME)}async findOrCreateFolder(e){try{const t=await gapi.client.drive.files.list({q:`name='${e}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,fields:"files(id, name)",spaces:"drive"});if(t.result.files&&t.result.files.length>0)return t.result.files[0].id;return(await gapi.client.drive.files.create({resource:{name:e,mimeType:"application/vnd.google-apps.folder"},fields:"id"})).result.id}catch(t){throw console.error("Error finding/creating folder:",t),t}}async uploadTextFile(e){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const t={name:e.name,mimeType:"text/plain",parents:[this.libraryFolderId]},r=new FormData;r.append("metadata",new Blob([JSON.stringify(t)],{type:"application/json"})),r.append("file",e);const n=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,size",{method:"POST",headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`},body:r}),o=await n.json();return{id:o.id,title:e.name.replace(/\.\w+$/,""),fileName:o.name,fileSize:parseInt(o.size),addedAt:Date.now(),driveFileId:o.id,encoding:"utf-8"}}catch(t){throw console.error("Error uploading file:",t),t}}async getLibraryBooks(){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const e=await gapi.client.drive.files.list({q:`'${this.libraryFolderId}' in parents and trashed=false`,fields:"files(id, name, size, createdTime, modifiedTime)",orderBy:"modifiedTime desc"});return e.result.files.map(e=>({id:e.id,title:e.name.replace(/\.\w+$/,""),fileName:e.name,fileSize:parseInt(e.size||"0"),addedAt:new Date(e.createdTime).getTime(),lastOpenedAt:new Date(e.modifiedTime).getTime(),driveFileId:e.id,encoding:"utf-8"}))}catch(e){throw console.error("Error getting library books:",e),e}}async downloadFileChunk(e,t,r){try{const n=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`,Range:`bytes=${t}-${r}`}});if(!n.ok)throw new Error(`Failed to download file chunk: ${n.statusText}`);return await n.text()}catch(n){throw console.error("Error downloading file chunk:",n),n}}async saveReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=`${e.bookId}_progress.json`,r=await gapi.client.drive.files.list({q:`name='${t}' and '${this.progressFolderId}' in parents and trashed=false`,fields:"files(id)"}),n=JSON.stringify(e),o=new Blob([n],{type:"application/json"});if(r.result.files&&r.result.files.length>0){const e=r.result.files[0].id;(new FormData).append("file",o),await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`},body:o})}else{const e={name:t,mimeType:"application/json",parents:[this.progressFolderId]},r=new FormData;r.append("metadata",new Blob([JSON.stringify(e)],{type:"application/json"})),r.append("file",o),await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`},body:r})}}catch(t){throw console.error("Error saving reading progress:",t),t}}async loadReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=`${e}_progress.json`,r=await gapi.client.drive.files.list({q:`name='${t}' and '${this.progressFolderId}' in parents and trashed=false`,fields:"files(id)"});if(!r.result.files||0===r.result.files.length)return null;const n=r.result.files[0].id,o=await fetch(`https://www.googleapis.com/drive/v3/files/${n}?alt=media`,{headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`}});if(!o.ok)return null;const i=await o.text();return JSON.parse(i)}catch(t){return console.error("Error loading reading progress:",t),null}}async deleteBook(e){try{await gapi.client.drive.files.delete({fileId:e});const t=`${e}_progress.json`,r=await gapi.client.drive.files.list({q:`name='${t}' and '${this.progressFolderId}' in parents and trashed=false`,fields:"files(id)"});r.result.files&&r.result.files.length>0&&await gapi.client.drive.files.delete({fileId:r.result.files[0].id})}catch(t){throw console.error("Error deleting book:",t),t}}};t(b,"instance");const v=b.getInstance(),k=class e{constructor(){t(this,"syncInterval",null),t(this,"SYNC_INTERVAL_MS",3e4),t(this,"LOCAL_STORAGE_KEY","syncviewer_progress"),t(this,"pendingUpdates",new Map),t(this,"isSyncing",!1)}static getInstance(){return e.instance||(e.instance=new e),e.instance}startAutoSync(){this.syncInterval||(this.syncAll(),this.syncInterval=window.setInterval(()=>{this.syncAll()},this.SYNC_INTERVAL_MS))}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}updateReadingProgress(e){const t=this.getAllLocalProgress();t[e.bookId]=e,localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.set(e.bookId,e)}getReadingProgress(e){return this.getAllLocalProgress()[e]||null}getAllLocalProgress(){const e=localStorage.getItem(this.LOCAL_STORAGE_KEY);if(!e)return{};try{return JSON.parse(e)}catch(t){return console.error("Error parsing local progress:",t),{}}}async syncBookProgress(e){try{const t=this.getReadingProgress(e),r=await v.loadReadingProgress(e);if(!t&&!r)return;if(!t&&r)return void this.updateReadingProgress(r);if(t&&!r)return await v.saveReadingProgress(t),void this.pendingUpdates.delete(e);t&&r&&(t.lastUpdated>r.lastUpdated?(await v.saveReadingProgress(t),this.pendingUpdates.delete(e)):r.lastUpdated>t.lastUpdated&&this.updateReadingProgress(r))}catch(t){throw console.error("Error syncing book progress:",t),t}}async syncAll(){if(!this.isSyncing&&0!==this.pendingUpdates.size){this.isSyncing=!0;try{const e=[];for(const[t,r]of this.pendingUpdates)e.push(v.saveReadingProgress(r).then(()=>{this.pendingUpdates.delete(t)}));await Promise.all(e)}catch(e){console.error("Error syncing all progress:",e)}finally{this.isSyncing=!1}}}async fetchLatestProgress(e){try{const t=await v.loadReadingProgress(e);if(t){const r=this.getReadingProgress(e);return(!r||t.lastUpdated>r.lastUpdated)&&this.updateReadingProgress(t),t}return null}catch(t){return console.error("Error fetching latest progress:",t),null}}async syncAllBooks(e){try{const t=e.map(e=>this.syncBookProgress(e));await Promise.all(t)}catch(t){console.error("Error syncing all books:",t)}}clearLocalProgress(){localStorage.removeItem(this.LOCAL_STORAGE_KEY),this.pendingUpdates.clear()}clearBookProgress(e){const t=this.getAllLocalProgress();delete t[e],localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.delete(e)}getSyncStatus(){return{isSyncing:this.isSyncing,pendingCount:this.pendingUpdates.size}}async syncNow(){await this.syncAll()}};t(k,"instance");const S=k.getInstance(),I=({onBookSelect:e})=>{const[t,n]=r.useState([]),[o,i]=r.useState(!0),[s,a]=r.useState(!1),[l,c]=r.useState(new Map),d=r.useRef(null);r.useEffect(()=>{p()},[]);const p=async()=>{try{i(!0);const e=await v.getLibraryBooks();n(e);const t=new Map;for(const r of e){const e=S.getReadingProgress(r.id);if(e)t.set(r.id,e);else{const e=await S.fetchLatestProgress(r.id);e&&t.set(r.id,e)}}c(t)}catch(e){console.error("Error loading library:",e),alert("서재를 불러오는데 실패했습니다.")}finally{i(!1)}};return o?u.jsx("div",{style:C.loadingContainer,children:u.jsx("p",{children:"서재를 불러오는 중..."})}):u.jsxs("div",{style:C.container,children:[u.jsxs("div",{style:C.header,children:[u.jsx("h1",{style:C.title,children:"내 서재"}),u.jsx("button",{onClick:()=>{var e;return null==(e=d.current)?void 0:e.click()},disabled:s,style:C.uploadButton,children:s?"업로드 중...":"+ 책 추가"}),u.jsx("input",{ref:d,type:"file",accept:".txt,text/plain",onChange:async e=>{const r=e.target.files;if(!r||0===r.length)return;const o=r[0];if(o.type.includes("text")||o.name.endsWith(".txt"))try{a(!0);const e=await v.uploadTextFile(o);n([e,...t]),alert("파일이 서재에 추가되었습니다.")}catch(i){console.error("Error uploading file:",i),alert("파일 업로드에 실패했습니다.")}finally{a(!1),d.current&&(d.current.value="")}else alert("텍스트 파일(.txt)만 업로드할 수 있습니다.")},style:{display:"none"}})]}),0===t.length?u.jsxs("div",{style:C.emptyState,children:[u.jsx("p",{style:C.emptyText,children:"서재가 비어있습니다."}),u.jsx("p",{style:C.emptySubtext,children:"텍스트 파일을 추가하여 시작하세요."})]}):u.jsx("div",{style:C.bookGrid,children:t.map(r=>{const o=l.get(r.id),i=(null==o?void 0:o.percentage)||0;return u.jsxs("div",{style:C.bookCard,children:[u.jsxs("div",{style:C.bookInfo,children:[u.jsx("h3",{style:C.bookTitle,children:r.title}),u.jsxs("p",{style:C.bookMeta,children:[(a=r.fileSize,a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB")," • ",(s=r.addedAt,new Date(s).toLocaleDateString("ko-KR"))]}),o&&u.jsxs("div",{style:C.progressContainer,children:[u.jsx("div",{style:C.progressBar,children:u.jsx("div",{style:{...C.progressFill,width:`${i}%`}})}),u.jsxs("span",{style:C.progressText,children:[i.toFixed(0),"%"]})]})]}),u.jsxs("div",{style:C.bookActions,children:[u.jsx("button",{onClick:()=>e(r),style:C.openButton,children:"열기"}),u.jsx("button",{onClick:()=>(async e=>{if(confirm("이 책을 서재에서 삭제하시겠습니까?"))try{await v.deleteBook(e),S.clearBookProgress(e),n(t.filter(t=>t.id!==e)),alert("책이 삭제되었습니다.")}catch(r){console.error("Error deleting book:",r),alert("책 삭제에 실패했습니다.")}})(r.id),style:C.deleteButton,children:"삭제"})]})]},r.id);var s,a})})]})},C={container:{maxWidth:"1200px",margin:"0 auto",padding:"24px"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"32px"},title:{fontSize:"28px",fontWeight:"bold",color:"#333"},uploadButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},emptyState:{textAlign:"center",padding:"64px 24px"},emptyText:{fontSize:"20px",color:"#666",marginBottom:"8px"},emptySubtext:{fontSize:"16px",color:"#999"},bookGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"24px"},bookCard:{backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",padding:"20px",display:"flex",flexDirection:"column",gap:"16px"},bookInfo:{flex:1},bookTitle:{fontSize:"18px",fontWeight:"bold",color:"#333",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},bookMeta:{fontSize:"14px",color:"#666",marginBottom:"12px"},progressContainer:{display:"flex",alignItems:"center",gap:"12px"},progressBar:{flex:1,height:"8px",backgroundColor:"#e0e0e0",borderRadius:"4px",overflow:"hidden"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},progressText:{fontSize:"14px",color:"#666",minWidth:"40px"},bookActions:{display:"flex",gap:"8px"},openButton:{flex:1,backgroundColor:"#4285f4",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},deleteButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"}},j=(e,t)=>t.some(t=>e instanceof t);let B,E;const z=new WeakMap,A=new WeakMap,R=new WeakMap;let O={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return z.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return F(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function P(e){O=e(O)}function L(e){return(E||(E=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(_(this),t),F(this.request)}:function(...t){return F(e.apply(_(this),t))}}function T(e){return"function"==typeof e?L(e):(e instanceof IDBTransaction&&function(e){if(z.has(e))return;const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",i),e.removeEventListener("abort",i)},o=()=>{t(),n()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",o),e.addEventListener("error",i),e.addEventListener("abort",i)});z.set(e,t)}(e),j(e,B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,O):e)}function F(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,r)=>{const n=()=>{e.removeEventListener("success",o),e.removeEventListener("error",i)},o=()=>{t(F(e.result)),n()},i=()=>{r(e.error),n()};e.addEventListener("success",o),e.addEventListener("error",i)});return R.set(t,e),t}(e);if(A.has(e))return A.get(e);const t=T(e);return t!==e&&(A.set(e,t),R.set(t,e)),t}const _=e=>R.get(e);const D=["get","getKey","getAll","getAllKeys","count"],$=["put","add","delete","clear"],M=new Map;function N(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(M.get(t))return M.get(t);const r=t.replace(/FromIndex$/,""),n=t!==r,o=$.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!o&&!D.includes(r))return;const i=async function(e,...t){const i=this.transaction(e,o?"readwrite":"readonly");let s=i.store;return n&&(s=s.index(t.shift())),(await Promise.all([s[r](...t),o&&i.done]))[0]};return M.set(t,i),i}P(e=>({...e,get:(t,r,n)=>N(t,r)||e.get(t,r,n),has:(t,r)=>!!N(t,r)||e.has(t,r)}));const U=["continue","continuePrimaryKey","advance"],W={},K=new WeakMap,G=new WeakMap,V={get(e,t){if(!U.includes(t))return e[t];let r=W[t];return r||(r=W[t]=function(...e){K.set(this,G.get(this)[t](...e))}),r}};async function*H(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const r=new Proxy(t,V);for(G.set(r,t),R.set(r,_(t));t;)yield r,t=await(K.get(r)||t.continue()),K.delete(r)}function q(e,t){return t===Symbol.asyncIterator&&j(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&j(e,[IDBIndex,IDBObjectStore])}P(e=>({...e,get:(t,r,n)=>q(t,r)?H:e.get(t,r,n),has:(t,r)=>q(t,r)||e.has(t,r)}));const J=class e{constructor(){t(this,"db",null),t(this,"config",{chunkSize:524288,preloadChunks:2,maxCacheSize:10485760})}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(){this.db||(this.db=await function(e,t,{blocked:r,upgrade:n,blocking:o,terminated:i}={}){const s=indexedDB.open(e,t),a=F(s);return n&&s.addEventListener("upgradeneeded",e=>{n(F(s.result),e.oldVersion,e.newVersion,F(s.transaction),e)}),r&&s.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),a.then(e=>{i&&e.addEventListener("close",()=>i()),o&&e.addEventListener("versionchange",e=>o(e.oldVersion,e.newVersion,e))}).catch(()=>{}),a}("SyncViewerCache",1,{upgrade(e){const t=e.createObjectStore("chunks",{keyPath:"key"});t.createIndex("by-bookId","bookId"),t.createIndex("by-cachedAt","cachedAt")}}))}updateConfig(e){this.config={...this.config,...e}}async loadChunksAround(e,t,r){if(!this.db)throw new Error("Cache service not initialized");const n=Math.floor(r/this.config.chunkSize),o=Math.max(0,n-this.config.preloadChunks),i=Math.min(Math.ceil(t/this.config.chunkSize)-1,n+this.config.preloadChunks),s=[];for(let l=o;l<=i;l++)s.push(this.getOrFetchChunk(e,t,l));const a=(await Promise.all(s))[n-o];return await this.cleanupOldChunks(e),a.content}async getOrFetchChunk(e,t,r){if(!this.db)throw new Error("Cache service not initialized");const n=`${e}_${r}`,o=await this.db.get("chunks",n);if(o)return o;const i=r*this.config.chunkSize,s=Math.min(i+this.config.chunkSize-1,t-1),a={bookId:e,startOffset:i,endOffset:s,content:await v.downloadFileChunk(e,i,s),cachedAt:Date.now()};return await this.db.put("chunks",{...a,key:n}),a}async getContentAtPosition(e,t,r,n=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const o=Math.floor(r/this.config.chunkSize),i=Math.min(r+n,t),s=Math.floor(i/this.config.chunkSize),a=[];for(let d=o;d<=s;d++){const r=await this.getOrFetchChunk(e,t,d);a.push(r)}let l="";for(const d of a)l+=d.content;const c=r-o*this.config.chunkSize;return{content:l.substring(c,c+n),actualPosition:r}}async getContentWithContext(e,t,r,n=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const o=n,i=Math.max(0,r-o),s=Math.min(t,r+n+o)-i;return{content:(await this.getContentAtPosition(e,t,i,s)).content,offset:i,totalSize:t}}async cleanupOldChunks(e){if(this.db)try{const t=await this.db.getAll("chunks"),r=t.reduce((e,t)=>e+t.content.length,0);if(r>this.config.maxCacheSize){const n=t.filter(t=>t.bookId!==e).sort((e,t)=>e.cachedAt-t.cachedAt);let o=0;const i=r-this.config.maxCacheSize;for(const e of n){if(o>=i)break;const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t),o+=e.content.length}}}catch(t){console.error("Error cleaning up old chunks:",t)}}async clearBookCache(e){if(this.db)try{const t=await this.db.getAllFromIndex("chunks","by-bookId",e);for(const e of t){const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t)}}catch(t){console.error("Error clearing book cache:",t)}}async clearAllCache(){if(this.db)try{await this.db.clear("chunks")}catch(e){console.error("Error clearing all cache:",e)}}async getCacheStats(){if(!this.db)return{totalChunks:0,totalSize:0,books:new Set};const e=await this.db.getAll("chunks"),t=new Set(e.map(e=>e.bookId)),r=e.reduce((e,t)=>e+t.content.length,0);return{totalChunks:e.length,totalSize:r,books:t}}};t(J,"instance");const Y=J.getInstance(),Q=({book:e,onClose:t})=>{const[n,o]=r.useState(""),[i,s]=r.useState(!0),[a,l]=r.useState(0),[c,d]=r.useState(0),p=r.useRef(null),h=r.useRef(0),g=r.useRef(!0),f=r.useRef(Date.now());r.useEffect(()=>(y(),()=>{m()}),[e.id]);const y=async()=>{try{s(!0);const t=S.getReadingProgress(e.id);let r=0;if(t)r=t.position,l(r),d(t.percentage);else{const t=await S.fetchLatestProgress(e.id);t&&(r=t.position,l(r),d(t.percentage))}await x(r)}catch(r){console.error("Error initializing viewer:",r),alert("파일을 여는데 실패했습니다."),t()}finally{s(!1)}},x=async t=>{try{const r=await Y.getContentWithContext(e.id,e.fileSize,t,102400);o(r.content),h.current=r.offset,g.current&&t>0&&setTimeout(()=>{if(p.current){const e=(t-r.offset)/r.content.length;p.current.scrollTop=p.current.scrollHeight*e}g.current=!1},100)}catch(r){throw console.error("Error loading content:",r),r}},w=r.useCallback(()=>{if(!p.current||g.current)return;const t=p.current,r=t.scrollTop/t.scrollHeight,o=n.length,i=Math.floor(o*r),s=h.current+i,a=s/e.fileSize*100;l(s),d(a);const c=Date.now();if(c-f.current>5e3&&(m(s,a),f.current=c),r<.1&&h.current>0){const e=Math.max(0,s-51200);x(e)}else if(r>.9&&h.current+o<e.fileSize){const t=Math.min(e.fileSize-1,s+51200);x(t)}},[n,e.fileSize,e.id]),m=(t,r)=>{const n={bookId:e.id,position:t??a,percentage:r??c,lastUpdated:Date.now()};S.updateReadingProgress(n)};return i?u.jsx("div",{style:X.loadingContainer,children:u.jsx("p",{children:"파일을 불러오는 중..."})}):u.jsxs("div",{style:X.container,children:[u.jsxs("div",{style:X.header,children:[u.jsxs("div",{style:X.headerLeft,children:[u.jsx("button",{onClick:t,style:X.backButton,children:"← 서재로"}),u.jsx("h2",{style:X.title,children:e.title})]}),u.jsxs("div",{style:X.headerRight,children:[u.jsxs("span",{style:X.info,children:[(b=e.fileSize,b<1024?b+" B":b<1048576?(b/1024).toFixed(1)+" KB":(b/1048576).toFixed(1)+" MB")," • ",c.toFixed(1),"%"]}),u.jsx("button",{onClick:()=>{const t=prompt("이동할 위치 (%)를 입력하세요 (0-100):");if(!t)return;const r=parseFloat(t);if(isNaN(r)||r<0||r>100)return void alert("올바른 값을 입력하세요 (0-100)");const n=Math.floor(r/100*e.fileSize);l(n),d(r),x(n)},style:X.jumpButton,children:"위치 이동"})]})]}),u.jsx("div",{style:X.progressBar,children:u.jsx("div",{style:{...X.progressFill,width:`${c}%`}})}),u.jsx("div",{ref:p,onScroll:w,style:X.contentContainer,children:u.jsx("pre",{style:X.content,children:n})}),u.jsx("div",{style:X.footer,children:u.jsxs("span",{style:X.footerText,children:["위치: ",a.toLocaleString()," / ",e.fileSize.toLocaleString()," bytes"]})})]});var b},X={container:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"#f5f5f5"},header:{backgroundColor:"white",padding:"16px 24px",borderBottom:"1px solid #e0e0e0",display:"flex",justifyContent:"space-between",alignItems:"center"},headerLeft:{display:"flex",alignItems:"center",gap:"16px"},headerRight:{display:"flex",alignItems:"center",gap:"16px"},backButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},title:{fontSize:"20px",fontWeight:"bold",color:"#333",margin:0},info:{fontSize:"14px",color:"#666"},jumpButton:{backgroundColor:"#34a853",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},progressBar:{height:"4px",backgroundColor:"#e0e0e0",position:"relative"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},contentContainer:{flex:1,overflow:"auto",backgroundColor:"white",padding:"24px"},content:{fontFamily:"monospace",fontSize:"16px",lineHeight:"1.6",color:"#333",whiteSpace:"pre-wrap",wordWrap:"break-word",margin:0},footer:{backgroundColor:"white",padding:"12px 24px",borderTop:"1px solid #e0e0e0",textAlign:"center"},footerText:{fontSize:"12px",color:"#666"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}},Z=()=>{const[e,t]=r.useState(!1),[,n]=r.useState(null),[o,i]=r.useState("library"),[s,a]=r.useState(null),[l,c]=r.useState(!1),d=async(e,r)=>{t(e),n(r),e?await p():S.stopAutoSync()},p=async()=>{try{c(!0),await v.initialize(),await Y.initialize(),S.startAutoSync()}catch(e){console.error("Error initializing services:",e),alert("서비스 초기화에 실패했습니다.")}finally{c(!1)}};return e?l?u.jsx("div",{style:ee.loadingContainer,children:u.jsx("p",{children:"서비스를 초기화하는 중..."})}):u.jsxs("div",{style:ee.app,children:[u.jsx(w,{onAuthChange:d}),"library"===o&&u.jsx(I,{onBookSelect:e=>{a(e),i("viewer")}}),"viewer"===o&&s&&u.jsx(Q,{book:s,onClose:()=>{i("library"),a(null),S.syncNow()}})]}):u.jsx(w,{onAuthChange:d})},ee={app:{minHeight:"100vh",backgroundColor:"#f5f5f5"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}};f.createRoot(document.getElementById("root")).render(u.jsx(o.StrictMode,{children:u.jsx(Z,{})}));
