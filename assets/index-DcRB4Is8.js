var e=Object.defineProperty,t=(t,n,r)=>((t,n,r)=>n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r)(t,"symbol"!=typeof n?n+"":n,r);import{r as n,a as r,R as i}from"./react-vendor-BXk_ma1u.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const n of e)if("childList"===n.type)for(const e of n.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var o={exports:{}},s={},a=n,l=Symbol.for("react.element"),c=Symbol.for("react.fragment"),d=Object.prototype.hasOwnProperty,p=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,h={key:!0,ref:!0,__self:!0,__source:!0};function g(e,t,n){var r,i={},o=null,s=null;for(r in void 0!==n&&(o=""+n),void 0!==t.key&&(o=""+t.key),void 0!==t.ref&&(s=t.ref),t)d.call(t,r)&&!h.hasOwnProperty(r)&&(i[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===i[r]&&(i[r]=t[r]);return{$$typeof:l,type:e,key:o,ref:s,props:i,_owner:p.current}}s.Fragment=c,s.jsx=g,s.jsxs=g,o.exports=s;var u=o.exports,f={},y=r;f.createRoot=y.createRoot,f.hydrateRoot=y.hydrateRoot;const x=({onAuthChange:e})=>{const[t,r]=n.useState(!1),[i,o]=n.useState(!1),[s,a]=n.useState(null);n.useEffect(()=>{l()},[]);const l=()=>{if("undefined"==typeof gapi)return void a("Google API 스크립트가 로드되지 않았습니다.");const e="AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",t="771509966039-u1t1h5ed2f2r0f3ur3jmcouhfbu3igmn.apps.googleusercontent.com";console.log("Initializing Google Auth with:",{apiKey:e.substring(0,10)+"...",clientId:t.substring(0,20)+"..."}),gapi.load("client:auth2",async()=>{try{await gapi.client.init({apiKey:e,clientId:t,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:"https://www.googleapis.com/auth/drive.file"});const n=gapi.auth2.getAuthInstance();n.isSignedIn.listen(e=>{c(e)}),c(n.isSignedIn.get()),r(!0),console.log("Google Auth initialized successfully")}catch(n){console.error("Error initializing Google Auth:",n);const e=(null==n?void 0:n.details)||(null==n?void 0:n.message)||"알 수 없는 오류";a(`Google 인증 초기화 실패: ${e}`)}})},c=t=>{if(o(t),t){const t=gapi.auth2.getAuthInstance().currentUser.get().getBasicProfile(),n={id:t.getId(),email:t.getEmail(),name:t.getName(),picture:t.getImageUrl()};e(!0,n)}else e(!1,null)},d=()=>{gapi.auth2.getAuthInstance().signIn()};return s?u.jsx("div",{style:w.errorContainer,children:u.jsxs("div",{style:w.errorCard,children:[u.jsx("h2",{style:w.errorTitle,children:"인증 오류"}),u.jsx("p",{style:w.error,children:s}),u.jsx("button",{onClick:()=>window.location.reload(),style:w.retryButton,children:"새로고침"}),u.jsxs("div",{style:w.helpText,children:[u.jsx("p",{children:"문제가 계속되면 다음을 확인하세요:"}),u.jsxs("ul",{style:w.helpList,children:[u.jsx("li",{children:"Google Cloud Console에서 OAuth 클라이언트 ID가 설정되었는지 확인"}),u.jsx("li",{children:"승인된 JavaScript 원본에 현재 도메인이 추가되었는지 확인"}),u.jsx("li",{children:"브라우저 콘솔(F12)에서 자세한 오류 메시지 확인"})]})]})]})}):t?i?u.jsx("div",{style:w.signedInContainer,children:u.jsx("button",{onClick:()=>{gapi.auth2.getAuthInstance().signOut()},style:w.signOutButton,children:"로그아웃"})}):u.jsx("div",{style:w.signInContainer,children:u.jsxs("div",{style:w.signInCard,children:[u.jsx("h1",{style:w.title,children:"SyncViewer"}),u.jsx("p",{style:w.subtitle,children:"PC와 모바일 간 동기화되는 텍스트 뷰어"}),u.jsx("button",{onClick:d,style:w.signInButton,children:"Google 계정으로 로그인"})]})}):u.jsx("div",{style:w.loadingContainer,children:u.jsx("p",{children:"Google 인증을 초기화하는 중..."})})},w={signInContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},signInCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",textAlign:"center",maxWidth:"400px"},title:{fontSize:"32px",fontWeight:"bold",marginBottom:"16px",color:"#333"},subtitle:{fontSize:"16px",color:"#666",marginBottom:"32px"},signInButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},signedInContainer:{position:"absolute",top:"16px",right:"16px"},signOutButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},errorContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},errorCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",maxWidth:"600px"},errorTitle:{fontSize:"24px",fontWeight:"bold",marginBottom:"16px",color:"#333"},error:{color:"#f44336",fontSize:"16px",marginBottom:"24px",padding:"12px",backgroundColor:"#ffebee",borderRadius:"4px",border:"1px solid #ffcdd2"},retryButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500",marginBottom:"24px"},helpText:{fontSize:"14px",color:"#666",textAlign:"left"},helpList:{marginTop:"8px",paddingLeft:"20px"}},m=class e{constructor(){t(this,"isInitialized",!1),t(this,"LIBRARY_FOLDER_NAME","SyncViewer_Library"),t(this,"PROGRESS_FOLDER_NAME","SyncViewer_Progress"),t(this,"libraryFolderId",null),t(this,"progressFolderId",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(){this.isInitialized||(await new Promise(e=>{gapi.load("client",async()=>{await gapi.client.init({apiKey:"AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),this.isInitialized=!0,e()})}),await this.ensureFoldersExist())}async ensureFoldersExist(){this.libraryFolderId=await this.findOrCreateFolder(this.LIBRARY_FOLDER_NAME),this.progressFolderId=await this.findOrCreateFolder(this.PROGRESS_FOLDER_NAME)}async findOrCreateFolder(e){try{const t=await gapi.client.drive.files.list({q:`name='${e}' and mimeType='application/vnd.google-apps.folder' and trashed=false`,fields:"files(id, name)",spaces:"drive"});if(t.result.files&&t.result.files.length>0)return t.result.files[0].id;return(await gapi.client.drive.files.create({resource:{name:e,mimeType:"application/vnd.google-apps.folder"},fields:"id"})).result.id}catch(t){throw console.error("Error finding/creating folder:",t),t}}async uploadTextFile(e){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const t={name:e.name,mimeType:"text/plain",parents:[this.libraryFolderId]},n=new FormData;n.append("metadata",new Blob([JSON.stringify(t)],{type:"application/json"})),n.append("file",e);const r=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,size",{method:"POST",headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`},body:n}),i=await r.json();return{id:i.id,title:e.name.replace(/\.\w+$/,""),fileName:i.name,fileSize:parseInt(i.size),addedAt:Date.now(),driveFileId:i.id,encoding:"utf-8"}}catch(t){throw console.error("Error uploading file:",t),t}}async getLibraryBooks(){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const e=await gapi.client.drive.files.list({q:`'${this.libraryFolderId}' in parents and trashed=false`,fields:"files(id, name, size, createdTime, modifiedTime)",orderBy:"modifiedTime desc"});return e.result.files.map(e=>({id:e.id,title:e.name.replace(/\.\w+$/,""),fileName:e.name,fileSize:parseInt(e.size||"0"),addedAt:new Date(e.createdTime).getTime(),lastOpenedAt:new Date(e.modifiedTime).getTime(),driveFileId:e.id,encoding:"utf-8"}))}catch(e){throw console.error("Error getting library books:",e),e}}async downloadFileChunk(e,t,n){try{const r=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`,Range:`bytes=${t}-${n}`}});if(!r.ok)throw new Error(`Failed to download file chunk: ${r.statusText}`);return await r.text()}catch(r){throw console.error("Error downloading file chunk:",r),r}}async saveReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=`${e.bookId}_progress.json`,n=await gapi.client.drive.files.list({q:`name='${t}' and '${this.progressFolderId}' in parents and trashed=false`,fields:"files(id)"}),r=JSON.stringify(e),i=new Blob([r],{type:"application/json"});if(n.result.files&&n.result.files.length>0){const e=n.result.files[0].id;(new FormData).append("file",i),await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`},body:i})}else{const e={name:t,mimeType:"application/json",parents:[this.progressFolderId]},n=new FormData;n.append("metadata",new Blob([JSON.stringify(e)],{type:"application/json"})),n.append("file",i),await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`},body:n})}}catch(t){throw console.error("Error saving reading progress:",t),t}}async loadReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=`${e}_progress.json`,n=await gapi.client.drive.files.list({q:`name='${t}' and '${this.progressFolderId}' in parents and trashed=false`,fields:"files(id)"});if(!n.result.files||0===n.result.files.length)return null;const r=n.result.files[0].id,i=await fetch(`https://www.googleapis.com/drive/v3/files/${r}?alt=media`,{headers:{Authorization:`Bearer ${gapi.client.getToken().access_token}`}});if(!i.ok)return null;const o=await i.text();return JSON.parse(o)}catch(t){return console.error("Error loading reading progress:",t),null}}async deleteBook(e){try{await gapi.client.drive.files.delete({fileId:e});const t=`${e}_progress.json`,n=await gapi.client.drive.files.list({q:`name='${t}' and '${this.progressFolderId}' in parents and trashed=false`,fields:"files(id)"});n.result.files&&n.result.files.length>0&&await gapi.client.drive.files.delete({fileId:n.result.files[0].id})}catch(t){throw console.error("Error deleting book:",t),t}}};t(m,"instance");const b=m.getInstance(),k=class e{constructor(){t(this,"syncInterval",null),t(this,"SYNC_INTERVAL_MS",3e4),t(this,"LOCAL_STORAGE_KEY","syncviewer_progress"),t(this,"pendingUpdates",new Map),t(this,"isSyncing",!1)}static getInstance(){return e.instance||(e.instance=new e),e.instance}startAutoSync(){this.syncInterval||(this.syncAll(),this.syncInterval=window.setInterval(()=>{this.syncAll()},this.SYNC_INTERVAL_MS))}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}updateReadingProgress(e){const t=this.getAllLocalProgress();t[e.bookId]=e,localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.set(e.bookId,e)}getReadingProgress(e){return this.getAllLocalProgress()[e]||null}getAllLocalProgress(){const e=localStorage.getItem(this.LOCAL_STORAGE_KEY);if(!e)return{};try{return JSON.parse(e)}catch(t){return console.error("Error parsing local progress:",t),{}}}async syncBookProgress(e){try{const t=this.getReadingProgress(e),n=await b.loadReadingProgress(e);if(!t&&!n)return;if(!t&&n)return void this.updateReadingProgress(n);if(t&&!n)return await b.saveReadingProgress(t),void this.pendingUpdates.delete(e);t&&n&&(t.lastUpdated>n.lastUpdated?(await b.saveReadingProgress(t),this.pendingUpdates.delete(e)):n.lastUpdated>t.lastUpdated&&this.updateReadingProgress(n))}catch(t){throw console.error("Error syncing book progress:",t),t}}async syncAll(){if(!this.isSyncing&&0!==this.pendingUpdates.size){this.isSyncing=!0;try{const e=[];for(const[t,n]of this.pendingUpdates)e.push(b.saveReadingProgress(n).then(()=>{this.pendingUpdates.delete(t)}));await Promise.all(e)}catch(e){console.error("Error syncing all progress:",e)}finally{this.isSyncing=!1}}}async fetchLatestProgress(e){try{const t=await b.loadReadingProgress(e);if(t){const n=this.getReadingProgress(e);return(!n||t.lastUpdated>n.lastUpdated)&&this.updateReadingProgress(t),t}return null}catch(t){return console.error("Error fetching latest progress:",t),null}}async syncAllBooks(e){try{const t=e.map(e=>this.syncBookProgress(e));await Promise.all(t)}catch(t){console.error("Error syncing all books:",t)}}clearLocalProgress(){localStorage.removeItem(this.LOCAL_STORAGE_KEY),this.pendingUpdates.clear()}clearBookProgress(e){const t=this.getAllLocalProgress();delete t[e],localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.delete(e)}getSyncStatus(){return{isSyncing:this.isSyncing,pendingCount:this.pendingUpdates.size}}async syncNow(){await this.syncAll()}};t(k,"instance");const S=k.getInstance(),v=({onBookSelect:e})=>{const[t,r]=n.useState([]),[i,o]=n.useState(!0),[s,a]=n.useState(!1),[l,c]=n.useState(new Map),d=n.useRef(null);n.useEffect(()=>{p()},[]);const p=async()=>{try{o(!0);const e=await b.getLibraryBooks();r(e);const t=new Map;for(const n of e){const e=S.getReadingProgress(n.id);if(e)t.set(n.id,e);else{const e=await S.fetchLatestProgress(n.id);e&&t.set(n.id,e)}}c(t)}catch(e){console.error("Error loading library:",e),alert("서재를 불러오는데 실패했습니다.")}finally{o(!1)}};return i?u.jsx("div",{style:I.loadingContainer,children:u.jsx("p",{children:"서재를 불러오는 중..."})}):u.jsxs("div",{style:I.container,children:[u.jsxs("div",{style:I.header,children:[u.jsx("h1",{style:I.title,children:"내 서재"}),u.jsx("button",{onClick:()=>{var e;return null==(e=d.current)?void 0:e.click()},disabled:s,style:I.uploadButton,children:s?"업로드 중...":"+ 책 추가"}),u.jsx("input",{ref:d,type:"file",accept:".txt,text/plain",onChange:async e=>{const n=e.target.files;if(!n||0===n.length)return;const i=n[0];if(i.type.includes("text")||i.name.endsWith(".txt"))try{a(!0);const e=await b.uploadTextFile(i);r([e,...t]),alert("파일이 서재에 추가되었습니다.")}catch(o){console.error("Error uploading file:",o),alert("파일 업로드에 실패했습니다.")}finally{a(!1),d.current&&(d.current.value="")}else alert("텍스트 파일(.txt)만 업로드할 수 있습니다.")},style:{display:"none"}})]}),0===t.length?u.jsxs("div",{style:I.emptyState,children:[u.jsx("p",{style:I.emptyText,children:"서재가 비어있습니다."}),u.jsx("p",{style:I.emptySubtext,children:"텍스트 파일을 추가하여 시작하세요."})]}):u.jsx("div",{style:I.bookGrid,children:t.map(n=>{const i=l.get(n.id),o=(null==i?void 0:i.percentage)||0;return u.jsxs("div",{style:I.bookCard,children:[u.jsxs("div",{style:I.bookInfo,children:[u.jsx("h3",{style:I.bookTitle,children:n.title}),u.jsxs("p",{style:I.bookMeta,children:[(a=n.fileSize,a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB")," • ",(s=n.addedAt,new Date(s).toLocaleDateString("ko-KR"))]}),i&&u.jsxs("div",{style:I.progressContainer,children:[u.jsx("div",{style:I.progressBar,children:u.jsx("div",{style:{...I.progressFill,width:`${o}%`}})}),u.jsxs("span",{style:I.progressText,children:[o.toFixed(0),"%"]})]})]}),u.jsxs("div",{style:I.bookActions,children:[u.jsx("button",{onClick:()=>e(n),style:I.openButton,children:"열기"}),u.jsx("button",{onClick:()=>(async e=>{if(confirm("이 책을 서재에서 삭제하시겠습니까?"))try{await b.deleteBook(e),S.clearBookProgress(e),r(t.filter(t=>t.id!==e)),alert("책이 삭제되었습니다.")}catch(n){console.error("Error deleting book:",n),alert("책 삭제에 실패했습니다.")}})(n.id),style:I.deleteButton,children:"삭제"})]})]},n.id);var s,a})})]})},I={container:{maxWidth:"1200px",margin:"0 auto",padding:"24px"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"32px"},title:{fontSize:"28px",fontWeight:"bold",color:"#333"},uploadButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},emptyState:{textAlign:"center",padding:"64px 24px"},emptyText:{fontSize:"20px",color:"#666",marginBottom:"8px"},emptySubtext:{fontSize:"16px",color:"#999"},bookGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"24px"},bookCard:{backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",padding:"20px",display:"flex",flexDirection:"column",gap:"16px"},bookInfo:{flex:1},bookTitle:{fontSize:"18px",fontWeight:"bold",color:"#333",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},bookMeta:{fontSize:"14px",color:"#666",marginBottom:"12px"},progressContainer:{display:"flex",alignItems:"center",gap:"12px"},progressBar:{flex:1,height:"8px",backgroundColor:"#e0e0e0",borderRadius:"4px",overflow:"hidden"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},progressText:{fontSize:"14px",color:"#666",minWidth:"40px"},bookActions:{display:"flex",gap:"8px"},openButton:{flex:1,backgroundColor:"#4285f4",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},deleteButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"}},C=(e,t)=>t.some(t=>e instanceof t);let j,B;const z=new WeakMap,E=new WeakMap,A=new WeakMap;let R={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return z.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return T(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function O(e){R=e(R)}function P(e){return(B||(B=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(F(this),t),T(this.request)}:function(...t){return T(e.apply(F(this),t))}}function L(e){return"function"==typeof e?P(e):(e instanceof IDBTransaction&&function(e){if(z.has(e))return;const t=new Promise((t,n)=>{const r=()=>{e.removeEventListener("complete",i),e.removeEventListener("error",o),e.removeEventListener("abort",o)},i=()=>{t(),r()},o=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",i),e.addEventListener("error",o),e.addEventListener("abort",o)});z.set(e,t)}(e),C(e,j||(j=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,R):e)}function T(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,n)=>{const r=()=>{e.removeEventListener("success",i),e.removeEventListener("error",o)},i=()=>{t(T(e.result)),r()},o=()=>{n(e.error),r()};e.addEventListener("success",i),e.addEventListener("error",o)});return A.set(t,e),t}(e);if(E.has(e))return E.get(e);const t=L(e);return t!==e&&(E.set(e,t),A.set(t,e)),t}const F=e=>A.get(e);const _=["get","getKey","getAll","getAllKeys","count"],D=["put","add","delete","clear"],M=new Map;function $(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(M.get(t))return M.get(t);const n=t.replace(/FromIndex$/,""),r=t!==n,i=D.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!i&&!_.includes(n))return;const o=async function(e,...t){const o=this.transaction(e,i?"readwrite":"readonly");let s=o.store;return r&&(s=s.index(t.shift())),(await Promise.all([s[n](...t),i&&o.done]))[0]};return M.set(t,o),o}O(e=>({...e,get:(t,n,r)=>$(t,n)||e.get(t,n,r),has:(t,n)=>!!$(t,n)||e.has(t,n)}));const N=["continue","continuePrimaryKey","advance"],U={},W=new WeakMap,G=new WeakMap,K={get(e,t){if(!N.includes(t))return e[t];let n=U[t];return n||(n=U[t]=function(...e){W.set(this,G.get(this)[t](...e))}),n}};async function*V(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const n=new Proxy(t,K);for(G.set(n,t),A.set(n,F(t));t;)yield n,t=await(W.get(n)||t.continue()),W.delete(n)}function H(e,t){return t===Symbol.asyncIterator&&C(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&C(e,[IDBIndex,IDBObjectStore])}O(e=>({...e,get:(t,n,r)=>H(t,n)?V:e.get(t,n,r),has:(t,n)=>H(t,n)||e.has(t,n)}));const q=class e{constructor(){t(this,"db",null),t(this,"config",{chunkSize:524288,preloadChunks:2,maxCacheSize:10485760})}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(){this.db||(this.db=await function(e,t,{blocked:n,upgrade:r,blocking:i,terminated:o}={}){const s=indexedDB.open(e,t),a=T(s);return r&&s.addEventListener("upgradeneeded",e=>{r(T(s.result),e.oldVersion,e.newVersion,T(s.transaction),e)}),n&&s.addEventListener("blocked",e=>n(e.oldVersion,e.newVersion,e)),a.then(e=>{o&&e.addEventListener("close",()=>o()),i&&e.addEventListener("versionchange",e=>i(e.oldVersion,e.newVersion,e))}).catch(()=>{}),a}("SyncViewerCache",1,{upgrade(e){const t=e.createObjectStore("chunks",{keyPath:"key"});t.createIndex("by-bookId","bookId"),t.createIndex("by-cachedAt","cachedAt")}}))}updateConfig(e){this.config={...this.config,...e}}async loadChunksAround(e,t,n){if(!this.db)throw new Error("Cache service not initialized");const r=Math.floor(n/this.config.chunkSize),i=Math.max(0,r-this.config.preloadChunks),o=Math.min(Math.ceil(t/this.config.chunkSize)-1,r+this.config.preloadChunks),s=[];for(let l=i;l<=o;l++)s.push(this.getOrFetchChunk(e,t,l));const a=(await Promise.all(s))[r-i];return await this.cleanupOldChunks(e),a.content}async getOrFetchChunk(e,t,n){if(!this.db)throw new Error("Cache service not initialized");const r=`${e}_${n}`,i=await this.db.get("chunks",r);if(i)return i;const o=n*this.config.chunkSize,s=Math.min(o+this.config.chunkSize-1,t-1),a={bookId:e,startOffset:o,endOffset:s,content:await b.downloadFileChunk(e,o,s),cachedAt:Date.now()};return await this.db.put("chunks",{...a,key:r}),a}async getContentAtPosition(e,t,n,r=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const i=Math.floor(n/this.config.chunkSize),o=Math.min(n+r,t),s=Math.floor(o/this.config.chunkSize),a=[];for(let d=i;d<=s;d++){const n=await this.getOrFetchChunk(e,t,d);a.push(n)}let l="";for(const d of a)l+=d.content;const c=n-i*this.config.chunkSize;return{content:l.substring(c,c+r),actualPosition:n}}async getContentWithContext(e,t,n,r=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const i=r,o=Math.max(0,n-i),s=Math.min(t,n+r+i)-o;return{content:(await this.getContentAtPosition(e,t,o,s)).content,offset:o,totalSize:t}}async cleanupOldChunks(e){if(this.db)try{const t=await this.db.getAll("chunks"),n=t.reduce((e,t)=>e+t.content.length,0);if(n>this.config.maxCacheSize){const r=t.filter(t=>t.bookId!==e).sort((e,t)=>e.cachedAt-t.cachedAt);let i=0;const o=n-this.config.maxCacheSize;for(const e of r){if(i>=o)break;const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t),i+=e.content.length}}}catch(t){console.error("Error cleaning up old chunks:",t)}}async clearBookCache(e){if(this.db)try{const t=await this.db.getAllFromIndex("chunks","by-bookId",e);for(const e of t){const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t)}}catch(t){console.error("Error clearing book cache:",t)}}async clearAllCache(){if(this.db)try{await this.db.clear("chunks")}catch(e){console.error("Error clearing all cache:",e)}}async getCacheStats(){if(!this.db)return{totalChunks:0,totalSize:0,books:new Set};const e=await this.db.getAll("chunks"),t=new Set(e.map(e=>e.bookId)),n=e.reduce((e,t)=>e+t.content.length,0);return{totalChunks:e.length,totalSize:n,books:t}}};t(q,"instance");const J=q.getInstance(),Y=({book:e,onClose:t})=>{const[r,i]=n.useState(""),[o,s]=n.useState(!0),[a,l]=n.useState(0),[c,d]=n.useState(0),p=n.useRef(null),h=n.useRef(0),g=n.useRef(!0),f=n.useRef(Date.now());n.useEffect(()=>(y(),()=>{m()}),[e.id]);const y=async()=>{try{s(!0);const t=S.getReadingProgress(e.id);let n=0;if(t)n=t.position,l(n),d(t.percentage);else{const t=await S.fetchLatestProgress(e.id);t&&(n=t.position,l(n),d(t.percentage))}await x(n)}catch(n){console.error("Error initializing viewer:",n),alert("파일을 여는데 실패했습니다."),t()}finally{s(!1)}},x=async t=>{try{const n=await J.getContentWithContext(e.id,e.fileSize,t,102400);i(n.content),h.current=n.offset,g.current&&t>0&&setTimeout(()=>{if(p.current){const e=(t-n.offset)/n.content.length;p.current.scrollTop=p.current.scrollHeight*e}g.current=!1},100)}catch(n){throw console.error("Error loading content:",n),n}},w=n.useCallback(()=>{if(!p.current||g.current)return;const t=p.current,n=t.scrollTop/t.scrollHeight,i=r.length,o=Math.floor(i*n),s=h.current+o,a=s/e.fileSize*100;l(s),d(a);const c=Date.now();if(c-f.current>5e3&&(m(s,a),f.current=c),n<.1&&h.current>0){const e=Math.max(0,s-51200);x(e)}else if(n>.9&&h.current+i<e.fileSize){const t=Math.min(e.fileSize-1,s+51200);x(t)}},[r,e.fileSize,e.id]),m=(t,n)=>{const r={bookId:e.id,position:t??a,percentage:n??c,lastUpdated:Date.now()};S.updateReadingProgress(r)};return o?u.jsx("div",{style:Q.loadingContainer,children:u.jsx("p",{children:"파일을 불러오는 중..."})}):u.jsxs("div",{style:Q.container,children:[u.jsxs("div",{style:Q.header,children:[u.jsxs("div",{style:Q.headerLeft,children:[u.jsx("button",{onClick:t,style:Q.backButton,children:"← 서재로"}),u.jsx("h2",{style:Q.title,children:e.title})]}),u.jsxs("div",{style:Q.headerRight,children:[u.jsxs("span",{style:Q.info,children:[(b=e.fileSize,b<1024?b+" B":b<1048576?(b/1024).toFixed(1)+" KB":(b/1048576).toFixed(1)+" MB")," • ",c.toFixed(1),"%"]}),u.jsx("button",{onClick:()=>{const t=prompt("이동할 위치 (%)를 입력하세요 (0-100):");if(!t)return;const n=parseFloat(t);if(isNaN(n)||n<0||n>100)return void alert("올바른 값을 입력하세요 (0-100)");const r=Math.floor(n/100*e.fileSize);l(r),d(n),x(r)},style:Q.jumpButton,children:"위치 이동"})]})]}),u.jsx("div",{style:Q.progressBar,children:u.jsx("div",{style:{...Q.progressFill,width:`${c}%`}})}),u.jsx("div",{ref:p,onScroll:w,style:Q.contentContainer,children:u.jsx("pre",{style:Q.content,children:r})}),u.jsx("div",{style:Q.footer,children:u.jsxs("span",{style:Q.footerText,children:["위치: ",a.toLocaleString()," / ",e.fileSize.toLocaleString()," bytes"]})})]});var b},Q={container:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"#f5f5f5"},header:{backgroundColor:"white",padding:"16px 24px",borderBottom:"1px solid #e0e0e0",display:"flex",justifyContent:"space-between",alignItems:"center"},headerLeft:{display:"flex",alignItems:"center",gap:"16px"},headerRight:{display:"flex",alignItems:"center",gap:"16px"},backButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},title:{fontSize:"20px",fontWeight:"bold",color:"#333",margin:0},info:{fontSize:"14px",color:"#666"},jumpButton:{backgroundColor:"#34a853",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},progressBar:{height:"4px",backgroundColor:"#e0e0e0",position:"relative"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},contentContainer:{flex:1,overflow:"auto",backgroundColor:"white",padding:"24px"},content:{fontFamily:"monospace",fontSize:"16px",lineHeight:"1.6",color:"#333",whiteSpace:"pre-wrap",wordWrap:"break-word",margin:0},footer:{backgroundColor:"white",padding:"12px 24px",borderTop:"1px solid #e0e0e0",textAlign:"center"},footerText:{fontSize:"12px",color:"#666"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}},X=()=>{const[e,t]=n.useState(!1),[,r]=n.useState(null),[i,o]=n.useState("library"),[s,a]=n.useState(null),[l,c]=n.useState(!1),d=async(e,n)=>{t(e),r(n),e?await p():S.stopAutoSync()},p=async()=>{try{c(!0),await b.initialize(),await J.initialize(),S.startAutoSync()}catch(e){console.error("Error initializing services:",e),alert("서비스 초기화에 실패했습니다.")}finally{c(!1)}};return e?l?u.jsx("div",{style:Z.loadingContainer,children:u.jsx("p",{children:"서비스를 초기화하는 중..."})}):u.jsxs("div",{style:Z.app,children:[u.jsx(x,{onAuthChange:d}),"library"===i&&u.jsx(v,{onBookSelect:e=>{a(e),o("viewer")}}),"viewer"===i&&s&&u.jsx(Y,{book:s,onClose:()=>{o("library"),a(null),S.syncNow()}})]}):u.jsx(x,{onAuthChange:d})},Z={app:{minHeight:"100vh",backgroundColor:"#f5f5f5"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}};f.createRoot(document.getElementById("root")).render(u.jsx(i.StrictMode,{children:u.jsx(X,{})}));
