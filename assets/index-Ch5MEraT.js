var e=Object.defineProperty,t=(t,r,o)=>((t,r,o)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[r]=o)(t,"symbol"!=typeof r?r+"":r,o);import{r,a as o,R as n}from"./react-vendor-BXk_ma1u.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const r of e)if("childList"===r.type)for(const e of r.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var i={exports:{}},s={},a=r,l=Symbol.for("react.element"),c=Symbol.for("react.fragment"),d=Object.prototype.hasOwnProperty,h=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};function g(e,t,r){var o,n={},i=null,s=null;for(o in void 0!==r&&(i=""+r),void 0!==t.key&&(i=""+t.key),void 0!==t.ref&&(s=t.ref),t)d.call(t,o)&&!p.hasOwnProperty(o)&&(n[o]=t[o]);if(e&&e.defaultProps)for(o in t=e.defaultProps)void 0===n[o]&&(n[o]=t[o]);return{$$typeof:l,type:e,key:i,ref:s,props:n,_owner:h.current}}s.Fragment=c,s.jsx=g,s.jsxs=g,i.exports=s;var u=i.exports,f={},y=o;f.createRoot=y.createRoot,f.hydrateRoot=y.hydrateRoot;const x={apiKey:"AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",clientId:"771509966039-vooe355g3k36v9lqu32ulq1nq7d352ne.apps.googleusercontent.com",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:"https://www.googleapis.com/auth/drive.file"};let w=null,m=null;const b=({onAuthChange:e})=>{const[t,o]=r.useState(!1),[n,i]=r.useState(!1),[s,a]=r.useState(!1),[l,c]=r.useState(null),[d,h]=r.useState(null),p=r.useRef(null),g=r.useRef(e);r.useEffect(()=>{g.current=e},[e]),r.useEffect(()=>{p.current=d},[d]),r.useEffect(()=>{(async()=>{let e=0;for(;("undefined"==typeof gapi||"undefined"==typeof google)&&e<50;)await new Promise(e=>setTimeout(e,100)),e++;if("undefined"==typeof gapi)return void c("Google API 스크립트가 로드되지 않았습니다.");if("undefined"==typeof google)return void c("Google Identity Services 스크립트가 로드되지 않았습니다.");const t=[];if(t.length>0)c(`설정 오류: ${t.join(", ")}`);else try{await new Promise((e,t)=>{gapi.load("client",async()=>{try{await gapi.client.init({apiKey:x.apiKey,discoveryDocs:x.discoveryDocs}),e()}catch(r){t(r)}})}),w=google.accounts.oauth2.initTokenClient({client_id:x.clientId,scope:x.scope,callback:e=>{if(a(!1),e.error)return console.error("Token error:",e),void c(`인증 오류: ${e.error_description||e.error}`);m=e.access_token;const t=localStorage.getItem("syncviewer_user"),r=p.current||(t?JSON.parse(t):{name:"사용자",email:""});h(r),i(!0),localStorage.setItem("syncviewer_user",JSON.stringify(r)),g.current(!0,r)},error_callback:e=>{a(!1),console.error("Token error callback:",e),"popup_closed"!==e.type&&c(`인증 오류: ${e.message||"알 수 없는 오류"}`)}}),o(!0)}catch(r){console.error("Error initializing Google Auth:",r),c(`Google 인증 초기화 실패: ${r.message||"알 수 없는 오류"}`)}})()},[]);const f=()=>{if(w){c(null),a(!0);try{w.requestAccessToken({prompt:"consent"})}catch(e){a(!1),console.error("Sign in error:",e),c(`로그인 오류: ${e.message||"알 수 없는 오류"}`)}}else c("인증 클라이언트가 초기화되지 않았습니다.")};return l?u.jsx("div",{style:v.errorContainer,children:u.jsxs("div",{style:v.errorCard,children:[u.jsx("h2",{style:v.errorTitle,children:"인증 오류"}),u.jsx("p",{style:v.error,children:l}),u.jsxs("div",{style:v.buttonGroup,children:[u.jsx("button",{onClick:()=>c(null),style:v.retryButton,children:"다시 시도"}),u.jsx("button",{onClick:()=>window.location.reload(),style:v.refreshButton,children:"새로고침"})]}),u.jsxs("div",{style:v.helpText,children:[u.jsxs("p",{children:[u.jsx("strong",{children:"현재 도메인:"})," ",window.location.origin]}),u.jsxs("p",{children:[u.jsx("strong",{children:"Client ID:"})," ",x.clientId.substring(0,30),"..."]}),u.jsx("br",{}),u.jsx("p",{children:"문제가 계속되면 다음을 확인하세요:"}),u.jsxs("ul",{style:v.helpList,children:[u.jsxs("li",{children:[u.jsx("strong",{children:"Google Cloud Console"})," (console.cloud.google.com) 접속"]}),u.jsxs("li",{children:[u.jsx("strong",{children:"API 및 서비스 > 사용자 인증 정보"}),"로 이동"]}),u.jsx("li",{children:"OAuth 2.0 클라이언트 ID 클릭하여 설정 확인"}),u.jsxs("li",{children:[u.jsx("strong",{children:"승인된 JavaScript 원본"}),"에 ",u.jsx("code",{children:window.location.origin})," 추가"]}),u.jsxs("li",{children:[u.jsx("strong",{children:"Google Drive API"}),"가 활성화되어 있는지 확인"]})]})]})]})}):t?n?u.jsxs("div",{style:v.signedInContainer,children:[d&&u.jsx("span",{style:v.userName,children:d.name||d.email}),u.jsx("button",{onClick:()=>{m?google.accounts.oauth2.revoke(m,()=>{m=null,i(!1),h(null),localStorage.removeItem("syncviewer_user"),g.current(!1,null)}):(i(!1),h(null),localStorage.removeItem("syncviewer_user"),g.current(!1,null))},style:v.signOutButton,children:"로그아웃"})]}):u.jsx("div",{style:v.signInContainer,children:u.jsxs("div",{style:v.signInCard,children:[u.jsx("h1",{style:v.title,children:"SyncViewer"}),u.jsx("p",{style:v.subtitle,children:"PC와 모바일 간 동기화되는 텍스트 뷰어"}),u.jsx("button",{onClick:f,style:s?{...v.signInButton,...v.signInButtonDisabled}:v.signInButton,disabled:s,children:s?"로그인 중...":"Google 계정으로 로그인"})]})}):u.jsx("div",{style:v.loadingContainer,children:u.jsx("p",{children:"Google 인증을 초기화하는 중..."})})},v={signInContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},signInCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",textAlign:"center",maxWidth:"400px"},title:{fontSize:"32px",fontWeight:"bold",marginBottom:"16px",color:"#333"},subtitle:{fontSize:"16px",color:"#666",marginBottom:"32px"},signInButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},signInButtonDisabled:{backgroundColor:"#a0c4ff",cursor:"not-allowed"},signedInContainer:{position:"absolute",top:"16px",right:"16px",display:"flex",alignItems:"center",gap:"12px"},userName:{fontSize:"14px",color:"#666"},signOutButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},errorContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},errorCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",maxWidth:"600px"},errorTitle:{fontSize:"24px",fontWeight:"bold",marginBottom:"16px",color:"#333"},error:{color:"#f44336",fontSize:"16px",marginBottom:"24px",padding:"12px",backgroundColor:"#ffebee",borderRadius:"4px",border:"1px solid #ffcdd2"},buttonGroup:{display:"flex",gap:"12px",marginBottom:"24px"},retryButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},refreshButton:{backgroundColor:"#666",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},helpText:{fontSize:"14px",color:"#666",textAlign:"left"},helpList:{marginTop:"8px",paddingLeft:"20px"}},k=class e{constructor(){t(this,"isInitialized",!1),t(this,"LIBRARY_FOLDER_NAME","SyncViewer_Library"),t(this,"PROGRESS_FOLDER_NAME","SyncViewer_Progress"),t(this,"libraryFolderId",null),t(this,"progressFolderId",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}getToken(){const e=m;if(!e)throw new Error("Access token not available. Please sign in first.");return e}async initialize(){this.isInitialized||("undefined"!=typeof gapi&&gapi.client?this.isInitialized=!0:await new Promise(e=>{gapi.load("client",async()=>{await gapi.client.init({apiKey:"AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),this.isInitialized=!0,e()})}),await this.ensureFoldersExist())}async ensureFoldersExist(){this.libraryFolderId=await this.findOrCreateFolder(this.LIBRARY_FOLDER_NAME),this.progressFolderId=await this.findOrCreateFolder(this.PROGRESS_FOLDER_NAME)}async findOrCreateFolder(e){try{const t=this.getToken(),r=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${e}' and mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)&spaces=drive`,{headers:{Authorization:`Bearer ${t}`}}),o=await r.json();if(o.files&&o.files.length>0)return o.files[0].id;const n=await fetch("https://www.googleapis.com/drive/v3/files?fields=id",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({name:e,mimeType:"application/vnd.google-apps.folder"})});return(await n.json()).id}catch(t){throw console.error("Error finding/creating folder:",t),t}}async uploadTextFile(e){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const t=this.getToken(),r={name:e.name,mimeType:"text/plain",parents:[this.libraryFolderId]},o=new FormData;o.append("metadata",new Blob([JSON.stringify(r)],{type:"application/json"})),o.append("file",e);const n=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,size",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:o}),i=await n.json();return{id:i.id,title:e.name.replace(/\.\w+$/,""),fileName:i.name,fileSize:parseInt(i.size),addedAt:Date.now(),driveFileId:i.id,encoding:"utf-8"}}catch(t){throw console.error("Error uploading file:",t),t}}async getLibraryBooks(){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const e=this.getToken(),t=await fetch(`https://www.googleapis.com/drive/v3/files?q='${this.libraryFolderId}' in parents and trashed=false&fields=files(id,name,size,createdTime,modifiedTime)&orderBy=modifiedTime desc`,{headers:{Authorization:`Bearer ${e}`}}),r=await t.json();return(r.files||[]).map(e=>({id:e.id,title:e.name.replace(/\.\w+$/,""),fileName:e.name,fileSize:parseInt(e.size||"0"),addedAt:new Date(e.createdTime).getTime(),lastOpenedAt:new Date(e.modifiedTime).getTime(),driveFileId:e.id,encoding:"utf-8"}))}catch(e){throw console.error("Error getting library books:",e),e}}async downloadFileChunk(e,t,r){try{const o=this.getToken(),n=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${o}`,Range:`bytes=${t}-${r}`}});if(!n.ok)throw new Error(`Failed to download file chunk: ${n.statusText}`);return await n.text()}catch(o){throw console.error("Error downloading file chunk:",o),o}}async saveReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=this.getToken(),r=`${e.bookId}_progress.json`,o=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${r}' and '${this.progressFolderId}' in parents and trashed=false&fields=files(id)`,{headers:{Authorization:`Bearer ${t}`}}),n=await o.json(),i=JSON.stringify(e),s=new Blob([i],{type:"application/json"});if(n.files&&n.files.length>0){const e=n.files[0].id;await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${t}`},body:s})}else{const e={name:r,mimeType:"application/json",parents:[this.progressFolderId]},o=new FormData;o.append("metadata",new Blob([JSON.stringify(e)],{type:"application/json"})),o.append("file",s),await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:o})}}catch(t){throw console.error("Error saving reading progress:",t),t}}async loadReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=this.getToken(),r=`${e}_progress.json`,o=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${r}' and '${this.progressFolderId}' in parents and trashed=false&fields=files(id)`,{headers:{Authorization:`Bearer ${t}`}}),n=await o.json();if(!n.files||0===n.files.length)return null;const i=n.files[0].id,s=await fetch(`https://www.googleapis.com/drive/v3/files/${i}?alt=media`,{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)return null;const a=await s.text();return JSON.parse(a)}catch(t){return console.error("Error loading reading progress:",t),null}}async deleteBook(e){try{const t=this.getToken();await fetch(`https://www.googleapis.com/drive/v3/files/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});const r=`${e}_progress.json`,o=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${r}' and '${this.progressFolderId}' in parents and trashed=false&fields=files(id)`,{headers:{Authorization:`Bearer ${t}`}}),n=await o.json();n.files&&n.files.length>0&&await fetch(`https://www.googleapis.com/drive/v3/files/${n.files[0].id}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})}catch(t){throw console.error("Error deleting book:",t),t}}};t(k,"instance");const S=k.getInstance(),I=class e{constructor(){t(this,"syncInterval",null),t(this,"SYNC_INTERVAL_MS",3e4),t(this,"LOCAL_STORAGE_KEY","syncviewer_progress"),t(this,"pendingUpdates",new Map),t(this,"isSyncing",!1)}static getInstance(){return e.instance||(e.instance=new e),e.instance}startAutoSync(){this.syncInterval||(this.syncAll(),this.syncInterval=window.setInterval(()=>{this.syncAll()},this.SYNC_INTERVAL_MS))}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}updateReadingProgress(e){const t=this.getAllLocalProgress();t[e.bookId]=e,localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.set(e.bookId,e)}getReadingProgress(e){return this.getAllLocalProgress()[e]||null}getAllLocalProgress(){const e=localStorage.getItem(this.LOCAL_STORAGE_KEY);if(!e)return{};try{return JSON.parse(e)}catch(t){return console.error("Error parsing local progress:",t),{}}}async syncBookProgress(e){try{const t=this.getReadingProgress(e),r=await S.loadReadingProgress(e);if(!t&&!r)return;if(!t&&r)return void this.updateReadingProgress(r);if(t&&!r)return await S.saveReadingProgress(t),void this.pendingUpdates.delete(e);t&&r&&(t.lastUpdated>r.lastUpdated?(await S.saveReadingProgress(t),this.pendingUpdates.delete(e)):r.lastUpdated>t.lastUpdated&&this.updateReadingProgress(r))}catch(t){throw console.error("Error syncing book progress:",t),t}}async syncAll(){if(!this.isSyncing&&0!==this.pendingUpdates.size){this.isSyncing=!0;try{const e=[];for(const[t,r]of this.pendingUpdates)e.push(S.saveReadingProgress(r).then(()=>{this.pendingUpdates.delete(t)}));await Promise.all(e)}catch(e){console.error("Error syncing all progress:",e)}finally{this.isSyncing=!1}}}async fetchLatestProgress(e){try{const t=await S.loadReadingProgress(e);if(t){const r=this.getReadingProgress(e);return(!r||t.lastUpdated>r.lastUpdated)&&this.updateReadingProgress(t),t}return null}catch(t){return console.error("Error fetching latest progress:",t),null}}async syncAllBooks(e){try{const t=e.map(e=>this.syncBookProgress(e));await Promise.all(t)}catch(t){console.error("Error syncing all books:",t)}}clearLocalProgress(){localStorage.removeItem(this.LOCAL_STORAGE_KEY),this.pendingUpdates.clear()}clearBookProgress(e){const t=this.getAllLocalProgress();delete t[e],localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.delete(e)}getSyncStatus(){return{isSyncing:this.isSyncing,pendingCount:this.pendingUpdates.size}}async syncNow(){await this.syncAll()}};t(I,"instance");const C=I.getInstance(),j=({onBookSelect:e})=>{const[t,o]=r.useState([]),[n,i]=r.useState(!0),[s,a]=r.useState(!1),[l,c]=r.useState(new Map),d=r.useRef(null);r.useEffect(()=>{h()},[]);const h=async()=>{try{i(!0);const e=await S.getLibraryBooks();o(e);const t=new Map;for(const r of e){const e=C.getReadingProgress(r.id);if(e)t.set(r.id,e);else{const e=await C.fetchLatestProgress(r.id);e&&t.set(r.id,e)}}c(t)}catch(e){console.error("Error loading library:",e),alert("서재를 불러오는데 실패했습니다.")}finally{i(!1)}};return n?u.jsx("div",{style:B.loadingContainer,children:u.jsx("p",{children:"서재를 불러오는 중..."})}):u.jsxs("div",{style:B.container,children:[u.jsxs("div",{style:B.header,children:[u.jsx("h1",{style:B.title,children:"내 서재"}),u.jsx("button",{onClick:()=>{var e;return null==(e=d.current)?void 0:e.click()},disabled:s,style:B.uploadButton,children:s?"업로드 중...":"+ 책 추가"}),u.jsx("input",{ref:d,type:"file",accept:".txt,text/plain",onChange:async e=>{const r=e.target.files;if(!r||0===r.length)return;const n=r[0];if(n.type.includes("text")||n.name.endsWith(".txt"))try{a(!0);const e=await S.uploadTextFile(n);o([e,...t]),alert("파일이 서재에 추가되었습니다.")}catch(i){console.error("Error uploading file:",i),alert("파일 업로드에 실패했습니다.")}finally{a(!1),d.current&&(d.current.value="")}else alert("텍스트 파일(.txt)만 업로드할 수 있습니다.")},style:{display:"none"}})]}),0===t.length?u.jsxs("div",{style:B.emptyState,children:[u.jsx("p",{style:B.emptyText,children:"서재가 비어있습니다."}),u.jsx("p",{style:B.emptySubtext,children:"텍스트 파일을 추가하여 시작하세요."})]}):u.jsx("div",{style:B.bookGrid,children:t.map(r=>{const n=l.get(r.id),i=(null==n?void 0:n.percentage)||0;return u.jsxs("div",{style:B.bookCard,children:[u.jsxs("div",{style:B.bookInfo,children:[u.jsx("h3",{style:B.bookTitle,children:r.title}),u.jsxs("p",{style:B.bookMeta,children:[(a=r.fileSize,a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB")," • ",(s=r.addedAt,new Date(s).toLocaleDateString("ko-KR"))]}),n&&u.jsxs("div",{style:B.progressContainer,children:[u.jsx("div",{style:B.progressBar,children:u.jsx("div",{style:{...B.progressFill,width:`${i}%`}})}),u.jsxs("span",{style:B.progressText,children:[i.toFixed(0),"%"]})]})]}),u.jsxs("div",{style:B.bookActions,children:[u.jsx("button",{onClick:()=>e(r),style:B.openButton,children:"열기"}),u.jsx("button",{onClick:()=>(async e=>{if(confirm("이 책을 서재에서 삭제하시겠습니까?"))try{await S.deleteBook(e),C.clearBookProgress(e),o(t.filter(t=>t.id!==e)),alert("책이 삭제되었습니다.")}catch(r){console.error("Error deleting book:",r),alert("책 삭제에 실패했습니다.")}})(r.id),style:B.deleteButton,children:"삭제"})]})]},r.id);var s,a})})]})},B={container:{maxWidth:"1200px",margin:"0 auto",padding:"24px"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"32px"},title:{fontSize:"28px",fontWeight:"bold",color:"#333"},uploadButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},emptyState:{textAlign:"center",padding:"64px 24px"},emptyText:{fontSize:"20px",color:"#666",marginBottom:"8px"},emptySubtext:{fontSize:"16px",color:"#999"},bookGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"24px"},bookCard:{backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",padding:"20px",display:"flex",flexDirection:"column",gap:"16px"},bookInfo:{flex:1},bookTitle:{fontSize:"18px",fontWeight:"bold",color:"#333",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},bookMeta:{fontSize:"14px",color:"#666",marginBottom:"12px"},progressContainer:{display:"flex",alignItems:"center",gap:"12px"},progressBar:{flex:1,height:"8px",backgroundColor:"#e0e0e0",borderRadius:"4px",overflow:"hidden"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},progressText:{fontSize:"14px",color:"#666",minWidth:"40px"},bookActions:{display:"flex",gap:"8px"},openButton:{flex:1,backgroundColor:"#4285f4",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},deleteButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"}},z=(e,t)=>t.some(t=>e instanceof t);let E,A;const R=new WeakMap,O=new WeakMap,P=new WeakMap;let T={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return R.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return F(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function L(e){T=e(T)}function _(e){return(A||(A=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply($(this),t),F(this.request)}:function(...t){return F(e.apply($(this),t))}}function D(e){return"function"==typeof e?_(e):(e instanceof IDBTransaction&&function(e){if(R.has(e))return;const t=new Promise((t,r)=>{const o=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{t(),o()},i=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)});R.set(e,t)}(e),z(e,E||(E=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,T):e)}function F(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,r)=>{const o=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{t(F(e.result)),o()},i=()=>{r(e.error),o()};e.addEventListener("success",n),e.addEventListener("error",i)});return P.set(t,e),t}(e);if(O.has(e))return O.get(e);const t=D(e);return t!==e&&(O.set(e,t),P.set(t,e)),t}const $=e=>P.get(e);const M=["get","getKey","getAll","getAllKeys","count"],N=["put","add","delete","clear"],W=new Map;function U(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(W.get(t))return W.get(t);const r=t.replace(/FromIndex$/,""),o=t!==r,n=N.includes(r);if(!(r in(o?IDBIndex:IDBObjectStore).prototype)||!n&&!M.includes(r))return;const i=async function(e,...t){const i=this.transaction(e,n?"readwrite":"readonly");let s=i.store;return o&&(s=s.index(t.shift())),(await Promise.all([s[r](...t),n&&i.done]))[0]};return W.set(t,i),i}L(e=>({...e,get:(t,r,o)=>U(t,r)||e.get(t,r,o),has:(t,r)=>!!U(t,r)||e.has(t,r)}));const G=["continue","continuePrimaryKey","advance"],K={},q=new WeakMap,V=new WeakMap,J={get(e,t){if(!G.includes(t))return e[t];let r=K[t];return r||(r=K[t]=function(...e){q.set(this,V.get(this)[t](...e))}),r}};async function*H(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const r=new Proxy(t,J);for(V.set(r,t),P.set(r,$(t));t;)yield r,t=await(q.get(r)||t.continue()),q.delete(r)}function Y(e,t){return t===Symbol.asyncIterator&&z(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&z(e,[IDBIndex,IDBObjectStore])}L(e=>({...e,get:(t,r,o)=>Y(t,r)?H:e.get(t,r,o),has:(t,r)=>Y(t,r)||e.has(t,r)}));const Q=class e{constructor(){t(this,"db",null),t(this,"config",{chunkSize:524288,preloadChunks:2,maxCacheSize:10485760})}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(){this.db||(this.db=await function(e,t,{blocked:r,upgrade:o,blocking:n,terminated:i}={}){const s=indexedDB.open(e,t),a=F(s);return o&&s.addEventListener("upgradeneeded",e=>{o(F(s.result),e.oldVersion,e.newVersion,F(s.transaction),e)}),r&&s.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),a.then(e=>{i&&e.addEventListener("close",()=>i()),n&&e.addEventListener("versionchange",e=>n(e.oldVersion,e.newVersion,e))}).catch(()=>{}),a}("SyncViewerCache",1,{upgrade(e){const t=e.createObjectStore("chunks",{keyPath:"key"});t.createIndex("by-bookId","bookId"),t.createIndex("by-cachedAt","cachedAt")}}))}updateConfig(e){this.config={...this.config,...e}}async loadChunksAround(e,t,r){if(!this.db)throw new Error("Cache service not initialized");const o=Math.floor(r/this.config.chunkSize),n=Math.max(0,o-this.config.preloadChunks),i=Math.min(Math.ceil(t/this.config.chunkSize)-1,o+this.config.preloadChunks),s=[];for(let l=n;l<=i;l++)s.push(this.getOrFetchChunk(e,t,l));const a=(await Promise.all(s))[o-n];return await this.cleanupOldChunks(e),a.content}async getOrFetchChunk(e,t,r){if(!this.db)throw new Error("Cache service not initialized");const o=`${e}_${r}`,n=await this.db.get("chunks",o);if(n)return n;const i=r*this.config.chunkSize,s=Math.min(i+this.config.chunkSize-1,t-1),a={bookId:e,startOffset:i,endOffset:s,content:await S.downloadFileChunk(e,i,s),cachedAt:Date.now()};return await this.db.put("chunks",{...a,key:o}),a}async getContentAtPosition(e,t,r,o=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const n=Math.floor(r/this.config.chunkSize),i=Math.min(r+o,t),s=Math.floor(i/this.config.chunkSize),a=[];for(let d=n;d<=s;d++){const r=await this.getOrFetchChunk(e,t,d);a.push(r)}let l="";for(const d of a)l+=d.content;const c=r-n*this.config.chunkSize;return{content:l.substring(c,c+o),actualPosition:r}}async getContentWithContext(e,t,r,o=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const n=o,i=Math.max(0,r-n),s=Math.min(t,r+o+n)-i;return{content:(await this.getContentAtPosition(e,t,i,s)).content,offset:i,totalSize:t}}async cleanupOldChunks(e){if(this.db)try{const t=await this.db.getAll("chunks"),r=t.reduce((e,t)=>e+t.content.length,0);if(r>this.config.maxCacheSize){const o=t.filter(t=>t.bookId!==e).sort((e,t)=>e.cachedAt-t.cachedAt);let n=0;const i=r-this.config.maxCacheSize;for(const e of o){if(n>=i)break;const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t),n+=e.content.length}}}catch(t){console.error("Error cleaning up old chunks:",t)}}async clearBookCache(e){if(this.db)try{const t=await this.db.getAllFromIndex("chunks","by-bookId",e);for(const e of t){const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t)}}catch(t){console.error("Error clearing book cache:",t)}}async clearAllCache(){if(this.db)try{await this.db.clear("chunks")}catch(e){console.error("Error clearing all cache:",e)}}async getCacheStats(){if(!this.db)return{totalChunks:0,totalSize:0,books:new Set};const e=await this.db.getAll("chunks"),t=new Set(e.map(e=>e.bookId)),r=e.reduce((e,t)=>e+t.content.length,0);return{totalChunks:e.length,totalSize:r,books:t}}};t(Q,"instance");const X=Q.getInstance(),Z=({book:e,onClose:t})=>{const[o,n]=r.useState(""),[i,s]=r.useState(!0),[a,l]=r.useState(0),[c,d]=r.useState(0),h=r.useRef(null),p=r.useRef(0),g=r.useRef(!0),f=r.useRef(Date.now());r.useEffect(()=>(y(),()=>{m()}),[e.id]);const y=async()=>{try{s(!0);const t=C.getReadingProgress(e.id);let r=0;if(t)r=t.position,l(r),d(t.percentage);else{const t=await C.fetchLatestProgress(e.id);t&&(r=t.position,l(r),d(t.percentage))}await x(r)}catch(r){console.error("Error initializing viewer:",r),alert("파일을 여는데 실패했습니다."),t()}finally{s(!1)}},x=async t=>{try{const r=await X.getContentWithContext(e.id,e.fileSize,t,102400);n(r.content),p.current=r.offset,g.current&&t>0&&setTimeout(()=>{if(h.current){const e=(t-r.offset)/r.content.length;h.current.scrollTop=h.current.scrollHeight*e}g.current=!1},100)}catch(r){throw console.error("Error loading content:",r),r}},w=r.useCallback(()=>{if(!h.current||g.current)return;const t=h.current,r=t.scrollTop/t.scrollHeight,n=o.length,i=Math.floor(n*r),s=p.current+i,a=s/e.fileSize*100;l(s),d(a);const c=Date.now();if(c-f.current>5e3&&(m(s,a),f.current=c),r<.1&&p.current>0){const e=Math.max(0,s-51200);x(e)}else if(r>.9&&p.current+n<e.fileSize){const t=Math.min(e.fileSize-1,s+51200);x(t)}},[o,e.fileSize,e.id]),m=(t,r)=>{const o={bookId:e.id,position:t??a,percentage:r??c,lastUpdated:Date.now()};C.updateReadingProgress(o)};return i?u.jsx("div",{style:ee.loadingContainer,children:u.jsx("p",{children:"파일을 불러오는 중..."})}):u.jsxs("div",{style:ee.container,children:[u.jsxs("div",{style:ee.header,children:[u.jsxs("div",{style:ee.headerLeft,children:[u.jsx("button",{onClick:t,style:ee.backButton,children:"← 서재로"}),u.jsx("h2",{style:ee.title,children:e.title})]}),u.jsxs("div",{style:ee.headerRight,children:[u.jsxs("span",{style:ee.info,children:[(b=e.fileSize,b<1024?b+" B":b<1048576?(b/1024).toFixed(1)+" KB":(b/1048576).toFixed(1)+" MB")," • ",c.toFixed(1),"%"]}),u.jsx("button",{onClick:()=>{const t=prompt("이동할 위치 (%)를 입력하세요 (0-100):");if(!t)return;const r=parseFloat(t);if(isNaN(r)||r<0||r>100)return void alert("올바른 값을 입력하세요 (0-100)");const o=Math.floor(r/100*e.fileSize);l(o),d(r),x(o)},style:ee.jumpButton,children:"위치 이동"})]})]}),u.jsx("div",{style:ee.progressBar,children:u.jsx("div",{style:{...ee.progressFill,width:`${c}%`}})}),u.jsx("div",{ref:h,onScroll:w,style:ee.contentContainer,children:u.jsx("pre",{style:ee.content,children:o})}),u.jsx("div",{style:ee.footer,children:u.jsxs("span",{style:ee.footerText,children:["위치: ",a.toLocaleString()," / ",e.fileSize.toLocaleString()," bytes"]})})]});var b},ee={container:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"#f5f5f5"},header:{backgroundColor:"white",padding:"16px 24px",borderBottom:"1px solid #e0e0e0",display:"flex",justifyContent:"space-between",alignItems:"center"},headerLeft:{display:"flex",alignItems:"center",gap:"16px"},headerRight:{display:"flex",alignItems:"center",gap:"16px"},backButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},title:{fontSize:"20px",fontWeight:"bold",color:"#333",margin:0},info:{fontSize:"14px",color:"#666"},jumpButton:{backgroundColor:"#34a853",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},progressBar:{height:"4px",backgroundColor:"#e0e0e0",position:"relative"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},contentContainer:{flex:1,overflow:"auto",backgroundColor:"white",padding:"24px"},content:{fontFamily:"monospace",fontSize:"16px",lineHeight:"1.6",color:"#333",whiteSpace:"pre-wrap",wordWrap:"break-word",margin:0},footer:{backgroundColor:"white",padding:"12px 24px",borderTop:"1px solid #e0e0e0",textAlign:"center"},footerText:{fontSize:"12px",color:"#666"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}},te=()=>{const[e,t]=r.useState(!1),[,o]=r.useState(null),[n,i]=r.useState("library"),[s,a]=r.useState(null),[l,c]=r.useState(!1),d=async(e,r)=>{t(e),o(r),e?await h():C.stopAutoSync()},h=async()=>{try{c(!0),await S.initialize(),await X.initialize(),C.startAutoSync()}catch(e){console.error("Error initializing services:",e),alert("서비스 초기화에 실패했습니다.")}finally{c(!1)}};return e?l?u.jsx("div",{style:re.loadingContainer,children:u.jsx("p",{children:"서비스를 초기화하는 중..."})}):u.jsxs("div",{style:re.app,children:[u.jsx(b,{onAuthChange:d}),"library"===n&&u.jsx(j,{onBookSelect:e=>{a(e),i("viewer")}}),"viewer"===n&&s&&u.jsx(Z,{book:s,onClose:()=>{i("library"),a(null),C.syncNow()}})]}):u.jsx(b,{onAuthChange:d})},re={app:{minHeight:"100vh",backgroundColor:"#f5f5f5"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}};f.createRoot(document.getElementById("root")).render(u.jsx(n.StrictMode,{children:u.jsx(te,{})}));
