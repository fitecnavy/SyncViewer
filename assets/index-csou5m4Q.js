var e=Object.defineProperty,t=(t,o,r)=>((t,o,r)=>o in t?e(t,o,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[o]=r)(t,"symbol"!=typeof o?o+"":o,r);import{r as o,a as r,R as n}from"./react-vendor-BXk_ma1u.js";!function(){const e=document.createElement("link").relList;if(!(e&&e.supports&&e.supports("modulepreload"))){for(const e of document.querySelectorAll('link[rel="modulepreload"]'))t(e);new MutationObserver(e=>{for(const o of e)if("childList"===o.type)for(const e of o.addedNodes)"LINK"===e.tagName&&"modulepreload"===e.rel&&t(e)}).observe(document,{childList:!0,subtree:!0})}function t(e){if(e.ep)return;e.ep=!0;const t=function(e){const t={};return e.integrity&&(t.integrity=e.integrity),e.referrerPolicy&&(t.referrerPolicy=e.referrerPolicy),"use-credentials"===e.crossOrigin?t.credentials="include":"anonymous"===e.crossOrigin?t.credentials="omit":t.credentials="same-origin",t}(e);fetch(e.href,t)}}();var i={exports:{}},s={},a=o,l=Symbol.for("react.element"),c=Symbol.for("react.fragment"),d=Object.prototype.hasOwnProperty,h=a.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};function g(e,t,o){var r,n={},i=null,s=null;for(r in void 0!==o&&(i=""+o),void 0!==t.key&&(i=""+t.key),void 0!==t.ref&&(s=t.ref),t)d.call(t,r)&&!p.hasOwnProperty(r)&&(n[r]=t[r]);if(e&&e.defaultProps)for(r in t=e.defaultProps)void 0===n[r]&&(n[r]=t[r]);return{$$typeof:l,type:e,key:i,ref:s,props:n,_owner:h.current}}s.Fragment=c,s.jsx=g,s.jsxs=g,i.exports=s;var u=i.exports,f={},y=r;f.createRoot=y.createRoot,f.hydrateRoot=y.hydrateRoot;const x={apiKey:"AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",clientId:"771509966039-vooe355g3k36v9lqu32ulq1nq7d352ne.apps.googleusercontent.com",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],scope:"https://www.googleapis.com/auth/drive.file"};let w=null,m=null;const b=({onAuthChange:e})=>{const[t,r]=o.useState(!1),[n,i]=o.useState(!1),[s,a]=o.useState(null),[l,c]=o.useState(null),d=o.useCallback(async e=>{try{const t=JSON.parse(atob(e.credential.split(".")[1])),o={id:t.sub,email:t.email,name:t.name,picture:t.picture};c(o),w.requestAccessToken({prompt:""})}catch(t){console.error("Error processing credential:",t),a("인증 처리 중 오류가 발생했습니다.")}},[]),h=o.useCallback(async()=>{if("undefined"==typeof gapi)return void a("Google API 스크립트가 로드되지 않았습니다.");if("undefined"==typeof google)return void a("Google Identity Services 스크립트가 로드되지 않았습니다.");const t=[];if(t.length>0)a(`설정 오류: ${t.join(", ")}`);else try{await new Promise(e=>{gapi.load("client",async()=>{await gapi.client.init({apiKey:x.apiKey,discoveryDocs:x.discoveryDocs}),e()})}),w=google.accounts.oauth2.initTokenClient({client_id:x.clientId,scope:x.scope,callback:t=>{if(t.error)return console.error("Token error:",t),void a(`토큰 오류: ${t.error}`);m=t.access_token,i(!0),e(!0,l)}}),r(!0);const t=localStorage.getItem("syncviewer_user");if(t){const e=JSON.parse(t);c(e),w.requestAccessToken({prompt:""})}}catch(o){console.error("Error initializing Google Auth:",o),a(`Google 인증 초기화 실패: ${o.message||"알 수 없는 오류"}`)}},[e,l]);o.useEffect(()=>{const e=()=>{"undefined"!=typeof gapi&&"undefined"!=typeof google?h():setTimeout(e,100)};e()},[h]);const p=()=>{w?(google.accounts.id.initialize({client_id:x.clientId,callback:d,auto_select:!1}),google.accounts.id.prompt(e=>{(e.isNotDisplayed()||e.isSkippedMoment())&&w.requestAccessToken({prompt:"consent"})})):a("인증 클라이언트가 초기화되지 않았습니다.")};return o.useEffect(()=>{l&&n&&localStorage.setItem("syncviewer_user",JSON.stringify(l))},[l,n]),s?u.jsx("div",{style:v.errorContainer,children:u.jsxs("div",{style:v.errorCard,children:[u.jsx("h2",{style:v.errorTitle,children:"인증 오류"}),u.jsx("p",{style:v.error,children:s}),u.jsx("button",{onClick:()=>window.location.reload(),style:v.retryButton,children:"새로고침"}),u.jsxs("div",{style:v.helpText,children:[u.jsxs("p",{children:[u.jsx("strong",{children:"현재 도메인:"})," ",window.location.origin]}),u.jsxs("p",{children:[u.jsx("strong",{children:"Client ID:"})," ",x.clientId.substring(0,30),"..."]}),u.jsx("br",{}),u.jsx("p",{children:"문제가 계속되면 다음을 확인하세요:"}),u.jsxs("ul",{style:v.helpList,children:[u.jsxs("li",{children:[u.jsx("strong",{children:"Google Cloud Console"})," (console.cloud.google.com) 접속"]}),u.jsxs("li",{children:[u.jsx("strong",{children:"API 및 서비스 > 사용자 인증 정보"}),"로 이동"]}),u.jsx("li",{children:"OAuth 2.0 클라이언트 ID 클릭하여 설정 확인"}),u.jsxs("li",{children:[u.jsx("strong",{children:"승인된 JavaScript 원본"}),"에 ",u.jsx("code",{children:window.location.origin})," 추가"]}),u.jsxs("li",{children:[u.jsx("strong",{children:"Google Drive API"}),"가 활성화되어 있는지 확인"]}),u.jsx("li",{children:"브라우저 콘솔(F12)에서 자세한 오류 메시지 확인"})]}),u.jsx("p",{style:{marginTop:"16px",fontSize:"12px",color:"#999"},children:"자세한 설정 방법은 GOOGLE_SETUP.md 파일을 참고하세요."})]})]})}):t?n?u.jsxs("div",{style:v.signedInContainer,children:[l&&u.jsx("span",{style:v.userName,children:l.name}),u.jsx("button",{onClick:()=>{m?google.accounts.oauth2.revoke(m,()=>{m=null,i(!1),c(null),localStorage.removeItem("syncviewer_user"),e(!1,null)}):(i(!1),c(null),localStorage.removeItem("syncviewer_user"),e(!1,null))},style:v.signOutButton,children:"로그아웃"})]}):u.jsx("div",{style:v.signInContainer,children:u.jsxs("div",{style:v.signInCard,children:[u.jsx("h1",{style:v.title,children:"SyncViewer"}),u.jsx("p",{style:v.subtitle,children:"PC와 모바일 간 동기화되는 텍스트 뷰어"}),u.jsx("button",{onClick:p,style:v.signInButton,children:"Google 계정으로 로그인"})]})}):u.jsx("div",{style:v.loadingContainer,children:u.jsx("p",{children:"Google 인증을 초기화하는 중..."})})},v={signInContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},signInCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",textAlign:"center",maxWidth:"400px"},title:{fontSize:"32px",fontWeight:"bold",marginBottom:"16px",color:"#333"},subtitle:{fontSize:"16px",color:"#666",marginBottom:"32px"},signInButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},signedInContainer:{position:"absolute",top:"16px",right:"16px",display:"flex",alignItems:"center",gap:"12px"},userName:{fontSize:"14px",color:"#666"},signOutButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"},errorContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh",backgroundColor:"#f5f5f5"},errorCard:{backgroundColor:"white",padding:"48px",borderRadius:"8px",boxShadow:"0 2px 10px rgba(0,0,0,0.1)",maxWidth:"600px"},errorTitle:{fontSize:"24px",fontWeight:"bold",marginBottom:"16px",color:"#333"},error:{color:"#f44336",fontSize:"16px",marginBottom:"24px",padding:"12px",backgroundColor:"#ffebee",borderRadius:"4px",border:"1px solid #ffcdd2"},retryButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500",marginBottom:"24px"},helpText:{fontSize:"14px",color:"#666",textAlign:"left"},helpList:{marginTop:"8px",paddingLeft:"20px"}},k=class e{constructor(){t(this,"isInitialized",!1),t(this,"LIBRARY_FOLDER_NAME","SyncViewer_Library"),t(this,"PROGRESS_FOLDER_NAME","SyncViewer_Progress"),t(this,"libraryFolderId",null),t(this,"progressFolderId",null)}static getInstance(){return e.instance||(e.instance=new e),e.instance}getToken(){const e=m;if(!e)throw new Error("Access token not available. Please sign in first.");return e}async initialize(){this.isInitialized||("undefined"!=typeof gapi&&gapi.client?this.isInitialized=!0:await new Promise(e=>{gapi.load("client",async()=>{await gapi.client.init({apiKey:"AIzaSyAQxQu6PLy3iVk825OOpNt_JOf7BRUFqxI",discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),this.isInitialized=!0,e()})}),await this.ensureFoldersExist())}async ensureFoldersExist(){this.libraryFolderId=await this.findOrCreateFolder(this.LIBRARY_FOLDER_NAME),this.progressFolderId=await this.findOrCreateFolder(this.PROGRESS_FOLDER_NAME)}async findOrCreateFolder(e){try{const t=this.getToken(),o=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${e}' and mimeType='application/vnd.google-apps.folder' and trashed=false&fields=files(id,name)&spaces=drive`,{headers:{Authorization:`Bearer ${t}`}}),r=await o.json();if(r.files&&r.files.length>0)return r.files[0].id;const n=await fetch("https://www.googleapis.com/drive/v3/files?fields=id",{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({name:e,mimeType:"application/vnd.google-apps.folder"})});return(await n.json()).id}catch(t){throw console.error("Error finding/creating folder:",t),t}}async uploadTextFile(e){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const t=this.getToken(),o={name:e.name,mimeType:"text/plain",parents:[this.libraryFolderId]},r=new FormData;r.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json"})),r.append("file",e);const n=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id,name,size",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:r}),i=await n.json();return{id:i.id,title:e.name.replace(/\.\w+$/,""),fileName:i.name,fileSize:parseInt(i.size),addedAt:Date.now(),driveFileId:i.id,encoding:"utf-8"}}catch(t){throw console.error("Error uploading file:",t),t}}async getLibraryBooks(){if(!this.libraryFolderId)throw new Error("Library folder not initialized");try{const e=this.getToken(),t=await fetch(`https://www.googleapis.com/drive/v3/files?q='${this.libraryFolderId}' in parents and trashed=false&fields=files(id,name,size,createdTime,modifiedTime)&orderBy=modifiedTime desc`,{headers:{Authorization:`Bearer ${e}`}}),o=await t.json();return(o.files||[]).map(e=>({id:e.id,title:e.name.replace(/\.\w+$/,""),fileName:e.name,fileSize:parseInt(e.size||"0"),addedAt:new Date(e.createdTime).getTime(),lastOpenedAt:new Date(e.modifiedTime).getTime(),driveFileId:e.id,encoding:"utf-8"}))}catch(e){throw console.error("Error getting library books:",e),e}}async downloadFileChunk(e,t,o){try{const r=this.getToken(),n=await fetch(`https://www.googleapis.com/drive/v3/files/${e}?alt=media`,{headers:{Authorization:`Bearer ${r}`,Range:`bytes=${t}-${o}`}});if(!n.ok)throw new Error(`Failed to download file chunk: ${n.statusText}`);return await n.text()}catch(r){throw console.error("Error downloading file chunk:",r),r}}async saveReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=this.getToken(),o=`${e.bookId}_progress.json`,r=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${o}' and '${this.progressFolderId}' in parents and trashed=false&fields=files(id)`,{headers:{Authorization:`Bearer ${t}`}}),n=await r.json(),i=JSON.stringify(e),s=new Blob([i],{type:"application/json"});if(n.files&&n.files.length>0){const e=n.files[0].id;await fetch(`https://www.googleapis.com/upload/drive/v3/files/${e}?uploadType=media`,{method:"PATCH",headers:{Authorization:`Bearer ${t}`},body:s})}else{const e={name:o,mimeType:"application/json",parents:[this.progressFolderId]},r=new FormData;r.append("metadata",new Blob([JSON.stringify(e)],{type:"application/json"})),r.append("file",s),await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:`Bearer ${t}`},body:r})}}catch(t){throw console.error("Error saving reading progress:",t),t}}async loadReadingProgress(e){if(!this.progressFolderId)throw new Error("Progress folder not initialized");try{const t=this.getToken(),o=`${e}_progress.json`,r=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${o}' and '${this.progressFolderId}' in parents and trashed=false&fields=files(id)`,{headers:{Authorization:`Bearer ${t}`}}),n=await r.json();if(!n.files||0===n.files.length)return null;const i=n.files[0].id,s=await fetch(`https://www.googleapis.com/drive/v3/files/${i}?alt=media`,{headers:{Authorization:`Bearer ${t}`}});if(!s.ok)return null;const a=await s.text();return JSON.parse(a)}catch(t){return console.error("Error loading reading progress:",t),null}}async deleteBook(e){try{const t=this.getToken();await fetch(`https://www.googleapis.com/drive/v3/files/${e}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}});const o=`${e}_progress.json`,r=await fetch(`https://www.googleapis.com/drive/v3/files?q=name='${o}' and '${this.progressFolderId}' in parents and trashed=false&fields=files(id)`,{headers:{Authorization:`Bearer ${t}`}}),n=await r.json();n.files&&n.files.length>0&&await fetch(`https://www.googleapis.com/drive/v3/files/${n.files[0].id}`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`}})}catch(t){throw console.error("Error deleting book:",t),t}}};t(k,"instance");const S=k.getInstance(),C=class e{constructor(){t(this,"syncInterval",null),t(this,"SYNC_INTERVAL_MS",3e4),t(this,"LOCAL_STORAGE_KEY","syncviewer_progress"),t(this,"pendingUpdates",new Map),t(this,"isSyncing",!1)}static getInstance(){return e.instance||(e.instance=new e),e.instance}startAutoSync(){this.syncInterval||(this.syncAll(),this.syncInterval=window.setInterval(()=>{this.syncAll()},this.SYNC_INTERVAL_MS))}stopAutoSync(){this.syncInterval&&(clearInterval(this.syncInterval),this.syncInterval=null)}updateReadingProgress(e){const t=this.getAllLocalProgress();t[e.bookId]=e,localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.set(e.bookId,e)}getReadingProgress(e){return this.getAllLocalProgress()[e]||null}getAllLocalProgress(){const e=localStorage.getItem(this.LOCAL_STORAGE_KEY);if(!e)return{};try{return JSON.parse(e)}catch(t){return console.error("Error parsing local progress:",t),{}}}async syncBookProgress(e){try{const t=this.getReadingProgress(e),o=await S.loadReadingProgress(e);if(!t&&!o)return;if(!t&&o)return void this.updateReadingProgress(o);if(t&&!o)return await S.saveReadingProgress(t),void this.pendingUpdates.delete(e);t&&o&&(t.lastUpdated>o.lastUpdated?(await S.saveReadingProgress(t),this.pendingUpdates.delete(e)):o.lastUpdated>t.lastUpdated&&this.updateReadingProgress(o))}catch(t){throw console.error("Error syncing book progress:",t),t}}async syncAll(){if(!this.isSyncing&&0!==this.pendingUpdates.size){this.isSyncing=!0;try{const e=[];for(const[t,o]of this.pendingUpdates)e.push(S.saveReadingProgress(o).then(()=>{this.pendingUpdates.delete(t)}));await Promise.all(e)}catch(e){console.error("Error syncing all progress:",e)}finally{this.isSyncing=!1}}}async fetchLatestProgress(e){try{const t=await S.loadReadingProgress(e);if(t){const o=this.getReadingProgress(e);return(!o||t.lastUpdated>o.lastUpdated)&&this.updateReadingProgress(t),t}return null}catch(t){return console.error("Error fetching latest progress:",t),null}}async syncAllBooks(e){try{const t=e.map(e=>this.syncBookProgress(e));await Promise.all(t)}catch(t){console.error("Error syncing all books:",t)}}clearLocalProgress(){localStorage.removeItem(this.LOCAL_STORAGE_KEY),this.pendingUpdates.clear()}clearBookProgress(e){const t=this.getAllLocalProgress();delete t[e],localStorage.setItem(this.LOCAL_STORAGE_KEY,JSON.stringify(t)),this.pendingUpdates.delete(e)}getSyncStatus(){return{isSyncing:this.isSyncing,pendingCount:this.pendingUpdates.size}}async syncNow(){await this.syncAll()}};t(C,"instance");const I=C.getInstance(),j=({onBookSelect:e})=>{const[t,r]=o.useState([]),[n,i]=o.useState(!0),[s,a]=o.useState(!1),[l,c]=o.useState(new Map),d=o.useRef(null);o.useEffect(()=>{h()},[]);const h=async()=>{try{i(!0);const e=await S.getLibraryBooks();r(e);const t=new Map;for(const o of e){const e=I.getReadingProgress(o.id);if(e)t.set(o.id,e);else{const e=await I.fetchLatestProgress(o.id);e&&t.set(o.id,e)}}c(t)}catch(e){console.error("Error loading library:",e),alert("서재를 불러오는데 실패했습니다.")}finally{i(!1)}};return n?u.jsx("div",{style:z.loadingContainer,children:u.jsx("p",{children:"서재를 불러오는 중..."})}):u.jsxs("div",{style:z.container,children:[u.jsxs("div",{style:z.header,children:[u.jsx("h1",{style:z.title,children:"내 서재"}),u.jsx("button",{onClick:()=>{var e;return null==(e=d.current)?void 0:e.click()},disabled:s,style:z.uploadButton,children:s?"업로드 중...":"+ 책 추가"}),u.jsx("input",{ref:d,type:"file",accept:".txt,text/plain",onChange:async e=>{const o=e.target.files;if(!o||0===o.length)return;const n=o[0];if(n.type.includes("text")||n.name.endsWith(".txt"))try{a(!0);const e=await S.uploadTextFile(n);r([e,...t]),alert("파일이 서재에 추가되었습니다.")}catch(i){console.error("Error uploading file:",i),alert("파일 업로드에 실패했습니다.")}finally{a(!1),d.current&&(d.current.value="")}else alert("텍스트 파일(.txt)만 업로드할 수 있습니다.")},style:{display:"none"}})]}),0===t.length?u.jsxs("div",{style:z.emptyState,children:[u.jsx("p",{style:z.emptyText,children:"서재가 비어있습니다."}),u.jsx("p",{style:z.emptySubtext,children:"텍스트 파일을 추가하여 시작하세요."})]}):u.jsx("div",{style:z.bookGrid,children:t.map(o=>{const n=l.get(o.id),i=(null==n?void 0:n.percentage)||0;return u.jsxs("div",{style:z.bookCard,children:[u.jsxs("div",{style:z.bookInfo,children:[u.jsx("h3",{style:z.bookTitle,children:o.title}),u.jsxs("p",{style:z.bookMeta,children:[(a=o.fileSize,a<1024?a+" B":a<1048576?(a/1024).toFixed(1)+" KB":(a/1048576).toFixed(1)+" MB")," • ",(s=o.addedAt,new Date(s).toLocaleDateString("ko-KR"))]}),n&&u.jsxs("div",{style:z.progressContainer,children:[u.jsx("div",{style:z.progressBar,children:u.jsx("div",{style:{...z.progressFill,width:`${i}%`}})}),u.jsxs("span",{style:z.progressText,children:[i.toFixed(0),"%"]})]})]}),u.jsxs("div",{style:z.bookActions,children:[u.jsx("button",{onClick:()=>e(o),style:z.openButton,children:"열기"}),u.jsx("button",{onClick:()=>(async e=>{if(confirm("이 책을 서재에서 삭제하시겠습니까?"))try{await S.deleteBook(e),I.clearBookProgress(e),r(t.filter(t=>t.id!==e)),alert("책이 삭제되었습니다.")}catch(o){console.error("Error deleting book:",o),alert("책 삭제에 실패했습니다.")}})(o.id),style:z.deleteButton,children:"삭제"})]})]},o.id);var s,a})})]})},z={container:{maxWidth:"1200px",margin:"0 auto",padding:"24px"},header:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"32px"},title:{fontSize:"28px",fontWeight:"bold",color:"#333"},uploadButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"12px 24px",fontSize:"16px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"400px"},emptyState:{textAlign:"center",padding:"64px 24px"},emptyText:{fontSize:"20px",color:"#666",marginBottom:"8px"},emptySubtext:{fontSize:"16px",color:"#999"},bookGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"24px"},bookCard:{backgroundColor:"white",border:"1px solid #e0e0e0",borderRadius:"8px",padding:"20px",display:"flex",flexDirection:"column",gap:"16px"},bookInfo:{flex:1},bookTitle:{fontSize:"18px",fontWeight:"bold",color:"#333",marginBottom:"8px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},bookMeta:{fontSize:"14px",color:"#666",marginBottom:"12px"},progressContainer:{display:"flex",alignItems:"center",gap:"12px"},progressBar:{flex:1,height:"8px",backgroundColor:"#e0e0e0",borderRadius:"4px",overflow:"hidden"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},progressText:{fontSize:"14px",color:"#666",minWidth:"40px"},bookActions:{display:"flex",gap:"8px"},openButton:{flex:1,backgroundColor:"#4285f4",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer",fontWeight:"500"},deleteButton:{backgroundColor:"#f44336",color:"white",border:"none",padding:"10px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"}},E=(e,t)=>t.some(t=>e instanceof t);let B,A;const O=new WeakMap,R=new WeakMap,T=new WeakMap;let P={get(e,t,o){if(e instanceof IDBTransaction){if("done"===t)return O.get(e);if("store"===t)return o.objectStoreNames[1]?void 0:o.objectStore(o.objectStoreNames[0])}return F(e[t])},set:(e,t,o)=>(e[t]=o,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function L(e){P=e(P)}function _(e){return(A||(A=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply($(this),t),F(this.request)}:function(...t){return F(e.apply($(this),t))}}function D(e){return"function"==typeof e?_(e):(e instanceof IDBTransaction&&function(e){if(O.has(e))return;const t=new Promise((t,o)=>{const r=()=>{e.removeEventListener("complete",n),e.removeEventListener("error",i),e.removeEventListener("abort",i)},n=()=>{t(),r()},i=()=>{o(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",n),e.addEventListener("error",i),e.addEventListener("abort",i)});O.set(e,t)}(e),E(e,B||(B=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction]))?new Proxy(e,P):e)}function F(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,o)=>{const r=()=>{e.removeEventListener("success",n),e.removeEventListener("error",i)},n=()=>{t(F(e.result)),r()},i=()=>{o(e.error),r()};e.addEventListener("success",n),e.addEventListener("error",i)});return T.set(t,e),t}(e);if(R.has(e))return R.get(e);const t=D(e);return t!==e&&(R.set(e,t),T.set(t,e)),t}const $=e=>T.get(e);const M=["get","getKey","getAll","getAllKeys","count"],N=["put","add","delete","clear"],W=new Map;function U(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!=typeof t)return;if(W.get(t))return W.get(t);const o=t.replace(/FromIndex$/,""),r=t!==o,n=N.includes(o);if(!(o in(r?IDBIndex:IDBObjectStore).prototype)||!n&&!M.includes(o))return;const i=async function(e,...t){const i=this.transaction(e,n?"readwrite":"readonly");let s=i.store;return r&&(s=s.index(t.shift())),(await Promise.all([s[o](...t),n&&i.done]))[0]};return W.set(t,i),i}L(e=>({...e,get:(t,o,r)=>U(t,o)||e.get(t,o,r),has:(t,o)=>!!U(t,o)||e.has(t,o)}));const G=["continue","continuePrimaryKey","advance"],K={},q=new WeakMap,J=new WeakMap,V={get(e,t){if(!G.includes(t))return e[t];let o=K[t];return o||(o=K[t]=function(...e){q.set(this,J.get(this)[t](...e))}),o}};async function*H(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;const o=new Proxy(t,V);for(J.set(o,t),T.set(o,$(t));t;)yield o,t=await(q.get(o)||t.continue()),q.delete(o)}function Y(e,t){return t===Symbol.asyncIterator&&E(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&E(e,[IDBIndex,IDBObjectStore])}L(e=>({...e,get:(t,o,r)=>Y(t,o)?H:e.get(t,o,r),has:(t,o)=>Y(t,o)||e.has(t,o)}));const Q=class e{constructor(){t(this,"db",null),t(this,"config",{chunkSize:524288,preloadChunks:2,maxCacheSize:10485760})}static getInstance(){return e.instance||(e.instance=new e),e.instance}async initialize(){this.db||(this.db=await function(e,t,{blocked:o,upgrade:r,blocking:n,terminated:i}={}){const s=indexedDB.open(e,t),a=F(s);return r&&s.addEventListener("upgradeneeded",e=>{r(F(s.result),e.oldVersion,e.newVersion,F(s.transaction),e)}),o&&s.addEventListener("blocked",e=>o(e.oldVersion,e.newVersion,e)),a.then(e=>{i&&e.addEventListener("close",()=>i()),n&&e.addEventListener("versionchange",e=>n(e.oldVersion,e.newVersion,e))}).catch(()=>{}),a}("SyncViewerCache",1,{upgrade(e){const t=e.createObjectStore("chunks",{keyPath:"key"});t.createIndex("by-bookId","bookId"),t.createIndex("by-cachedAt","cachedAt")}}))}updateConfig(e){this.config={...this.config,...e}}async loadChunksAround(e,t,o){if(!this.db)throw new Error("Cache service not initialized");const r=Math.floor(o/this.config.chunkSize),n=Math.max(0,r-this.config.preloadChunks),i=Math.min(Math.ceil(t/this.config.chunkSize)-1,r+this.config.preloadChunks),s=[];for(let l=n;l<=i;l++)s.push(this.getOrFetchChunk(e,t,l));const a=(await Promise.all(s))[r-n];return await this.cleanupOldChunks(e),a.content}async getOrFetchChunk(e,t,o){if(!this.db)throw new Error("Cache service not initialized");const r=`${e}_${o}`,n=await this.db.get("chunks",r);if(n)return n;const i=o*this.config.chunkSize,s=Math.min(i+this.config.chunkSize-1,t-1),a={bookId:e,startOffset:i,endOffset:s,content:await S.downloadFileChunk(e,i,s),cachedAt:Date.now()};return await this.db.put("chunks",{...a,key:r}),a}async getContentAtPosition(e,t,o,r=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const n=Math.floor(o/this.config.chunkSize),i=Math.min(o+r,t),s=Math.floor(i/this.config.chunkSize),a=[];for(let d=n;d<=s;d++){const o=await this.getOrFetchChunk(e,t,d);a.push(o)}let l="";for(const d of a)l+=d.content;const c=o-n*this.config.chunkSize;return{content:l.substring(c,c+r),actualPosition:o}}async getContentWithContext(e,t,o,r=this.config.chunkSize){if(!this.db)throw new Error("Cache service not initialized");const n=r,i=Math.max(0,o-n),s=Math.min(t,o+r+n)-i;return{content:(await this.getContentAtPosition(e,t,i,s)).content,offset:i,totalSize:t}}async cleanupOldChunks(e){if(this.db)try{const t=await this.db.getAll("chunks"),o=t.reduce((e,t)=>e+t.content.length,0);if(o>this.config.maxCacheSize){const r=t.filter(t=>t.bookId!==e).sort((e,t)=>e.cachedAt-t.cachedAt);let n=0;const i=o-this.config.maxCacheSize;for(const e of r){if(n>=i)break;const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t),n+=e.content.length}}}catch(t){console.error("Error cleaning up old chunks:",t)}}async clearBookCache(e){if(this.db)try{const t=await this.db.getAllFromIndex("chunks","by-bookId",e);for(const e of t){const t=`${e.bookId}_${Math.floor(e.startOffset/this.config.chunkSize)}`;await this.db.delete("chunks",t)}}catch(t){console.error("Error clearing book cache:",t)}}async clearAllCache(){if(this.db)try{await this.db.clear("chunks")}catch(e){console.error("Error clearing all cache:",e)}}async getCacheStats(){if(!this.db)return{totalChunks:0,totalSize:0,books:new Set};const e=await this.db.getAll("chunks"),t=new Set(e.map(e=>e.bookId)),o=e.reduce((e,t)=>e+t.content.length,0);return{totalChunks:e.length,totalSize:o,books:t}}};t(Q,"instance");const X=Q.getInstance(),Z=({book:e,onClose:t})=>{const[r,n]=o.useState(""),[i,s]=o.useState(!0),[a,l]=o.useState(0),[c,d]=o.useState(0),h=o.useRef(null),p=o.useRef(0),g=o.useRef(!0),f=o.useRef(Date.now());o.useEffect(()=>(y(),()=>{m()}),[e.id]);const y=async()=>{try{s(!0);const t=I.getReadingProgress(e.id);let o=0;if(t)o=t.position,l(o),d(t.percentage);else{const t=await I.fetchLatestProgress(e.id);t&&(o=t.position,l(o),d(t.percentage))}await x(o)}catch(o){console.error("Error initializing viewer:",o),alert("파일을 여는데 실패했습니다."),t()}finally{s(!1)}},x=async t=>{try{const o=await X.getContentWithContext(e.id,e.fileSize,t,102400);n(o.content),p.current=o.offset,g.current&&t>0&&setTimeout(()=>{if(h.current){const e=(t-o.offset)/o.content.length;h.current.scrollTop=h.current.scrollHeight*e}g.current=!1},100)}catch(o){throw console.error("Error loading content:",o),o}},w=o.useCallback(()=>{if(!h.current||g.current)return;const t=h.current,o=t.scrollTop/t.scrollHeight,n=r.length,i=Math.floor(n*o),s=p.current+i,a=s/e.fileSize*100;l(s),d(a);const c=Date.now();if(c-f.current>5e3&&(m(s,a),f.current=c),o<.1&&p.current>0){const e=Math.max(0,s-51200);x(e)}else if(o>.9&&p.current+n<e.fileSize){const t=Math.min(e.fileSize-1,s+51200);x(t)}},[r,e.fileSize,e.id]),m=(t,o)=>{const r={bookId:e.id,position:t??a,percentage:o??c,lastUpdated:Date.now()};I.updateReadingProgress(r)};return i?u.jsx("div",{style:ee.loadingContainer,children:u.jsx("p",{children:"파일을 불러오는 중..."})}):u.jsxs("div",{style:ee.container,children:[u.jsxs("div",{style:ee.header,children:[u.jsxs("div",{style:ee.headerLeft,children:[u.jsx("button",{onClick:t,style:ee.backButton,children:"← 서재로"}),u.jsx("h2",{style:ee.title,children:e.title})]}),u.jsxs("div",{style:ee.headerRight,children:[u.jsxs("span",{style:ee.info,children:[(b=e.fileSize,b<1024?b+" B":b<1048576?(b/1024).toFixed(1)+" KB":(b/1048576).toFixed(1)+" MB")," • ",c.toFixed(1),"%"]}),u.jsx("button",{onClick:()=>{const t=prompt("이동할 위치 (%)를 입력하세요 (0-100):");if(!t)return;const o=parseFloat(t);if(isNaN(o)||o<0||o>100)return void alert("올바른 값을 입력하세요 (0-100)");const r=Math.floor(o/100*e.fileSize);l(r),d(o),x(r)},style:ee.jumpButton,children:"위치 이동"})]})]}),u.jsx("div",{style:ee.progressBar,children:u.jsx("div",{style:{...ee.progressFill,width:`${c}%`}})}),u.jsx("div",{ref:h,onScroll:w,style:ee.contentContainer,children:u.jsx("pre",{style:ee.content,children:r})}),u.jsx("div",{style:ee.footer,children:u.jsxs("span",{style:ee.footerText,children:["위치: ",a.toLocaleString()," / ",e.fileSize.toLocaleString()," bytes"]})})]});var b},ee={container:{display:"flex",flexDirection:"column",height:"100vh",backgroundColor:"#f5f5f5"},header:{backgroundColor:"white",padding:"16px 24px",borderBottom:"1px solid #e0e0e0",display:"flex",justifyContent:"space-between",alignItems:"center"},headerLeft:{display:"flex",alignItems:"center",gap:"16px"},headerRight:{display:"flex",alignItems:"center",gap:"16px"},backButton:{backgroundColor:"#4285f4",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},title:{fontSize:"20px",fontWeight:"bold",color:"#333",margin:0},info:{fontSize:"14px",color:"#666"},jumpButton:{backgroundColor:"#34a853",color:"white",border:"none",padding:"8px 16px",fontSize:"14px",borderRadius:"4px",cursor:"pointer"},progressBar:{height:"4px",backgroundColor:"#e0e0e0",position:"relative"},progressFill:{height:"100%",backgroundColor:"#4285f4",transition:"width 0.3s ease"},contentContainer:{flex:1,overflow:"auto",backgroundColor:"white",padding:"24px"},content:{fontFamily:"monospace",fontSize:"16px",lineHeight:"1.6",color:"#333",whiteSpace:"pre-wrap",wordWrap:"break-word",margin:0},footer:{backgroundColor:"white",padding:"12px 24px",borderTop:"1px solid #e0e0e0",textAlign:"center"},footerText:{fontSize:"12px",color:"#666"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}},te=()=>{const[e,t]=o.useState(!1),[,r]=o.useState(null),[n,i]=o.useState("library"),[s,a]=o.useState(null),[l,c]=o.useState(!1),d=async(e,o)=>{t(e),r(o),e?await h():I.stopAutoSync()},h=async()=>{try{c(!0),await S.initialize(),await X.initialize(),I.startAutoSync()}catch(e){console.error("Error initializing services:",e),alert("서비스 초기화에 실패했습니다.")}finally{c(!1)}};return e?l?u.jsx("div",{style:oe.loadingContainer,children:u.jsx("p",{children:"서비스를 초기화하는 중..."})}):u.jsxs("div",{style:oe.app,children:[u.jsx(b,{onAuthChange:d}),"library"===n&&u.jsx(j,{onBookSelect:e=>{a(e),i("viewer")}}),"viewer"===n&&s&&u.jsx(Z,{book:s,onClose:()=>{i("library"),a(null),I.syncNow()}})]}):u.jsx(b,{onAuthChange:d})},oe={app:{minHeight:"100vh",backgroundColor:"#f5f5f5"},loadingContainer:{display:"flex",justifyContent:"center",alignItems:"center",minHeight:"100vh"}};f.createRoot(document.getElementById("root")).render(u.jsx(n.StrictMode,{children:u.jsx(te,{})}));
